<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://cdn.quilljs.com https://pagead2.googlesyndication.com https://static.cloudflareinsights.com https://*.gstatic.com https://*.adtrafficquality.google; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com https://cdn.quilljs.com; img-src 'self' data: https: blob:; font-src 'self' data: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.gstatic.com; frame-src https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://*.adtrafficquality.google https://*.google.com; connect-src 'self' https://*.supabase.co https://accounts.google.com https://cdn.jsdelivr.net https://goatmouth-odds-api.onrender.com https://*.google https://*.gstatic.com;">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Panel - GoatMouth</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <script>
        window.ODDS_API_URL = 'https://goatmouth-odds-api.onrender.com';
    </script>
    <meta name="theme-color" content="#1a4d2e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous">

    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS (compiled) -->
    <link rel="stylesheet" href="css/output.css?v=4.6">
    <link rel="stylesheet" href="css/styles.css?v=4.6">
    <link rel="stylesheet" href="css/mobile.css?v=4.6">
    <link rel="stylesheet" href="css/admin.css?v=4.6">
    <link rel="stylesheet" href="css/admin-full.css?v=4.6">
    <link rel="stylesheet" href="css/admin-overrides.css?v=4.6">
    <script>
        // Reserved for future configuration
    </script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2580594240598942"
         crossorigin="anonymous"></script>
</head>
<body>
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Logo Header -->
    <div class="logo-header">
        <div class="flex items-center gap-3">
            <button class="hamburger" id="hamburger" type="button" aria-label="Toggle menu" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="logo-container">
                <img src="assets/official.png" alt="GoatMouth Logo">
                <span class="logo-text">GoatMouth Admin Panel</span>
            </div>
        </div>
        <div class="user-info">
            <div class="user-badge cursor-pointer" id="adminProfileBtn" title="View Profile">
                <i class="fa-solid fa-user mr-2"></i>
                <span id="admin-username">Admin</span>
                <span class="role-badge">Admin</span>
            </div>
            <button class="btn secondary" id="backToAppBtn" title="Back to App">
                <i class="fa-solid fa-home"></i>
                <span class="btn-text">Home</span>
            </button>
            <button class="btn secondary" id="admin-signout" title="Sign Out">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span class="btn-text">Sign Out</span>
            </button>
        </div>
    </div>

    <!-- Single Unified Navigation Bar -->
    <div class="menubar">
        <button class="active" data-view="dashboard">
            <i class="fa-solid fa-chart-line"></i> Dashboard
        </button>
        <button data-view="markets">
            <i class="fa-solid fa-chart-simple"></i> Markets
        </button>
        <button data-view="banners">
            <i class="fa-solid fa-image"></i> Banners
        </button>
        <button data-view="users">
            <i class="fa-solid fa-users"></i> Users
        </button>
        <button data-view="activity">
            <i class="fa-solid fa-clock-rotate-left"></i> Activity
        </button>
        <button data-view="transactions">
            <i class="fa-solid fa-receipt"></i> Transactions
        </button>
        <button data-view="messages">
            <i class="fa-solid fa-envelope"></i> Messages
            <span id="unread-badge" class="badge info hidden">0</span>
        </button>
        <button data-view="voting">
            <i class="fa-solid fa-check-circle"></i> Voting
            <span id="pending-proposals-badge" class="badge warning hidden">0</span>
        </button>
        <button data-view="api">
            <i class="fa-solid fa-signal"></i> API & Insights
        </button>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard Panel -->
            <section class="tabpanel active" id="dashboardPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-gauge-high"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Dashboard</h2>
                        <p>Overview of platform metrics and activity</p>
                    </div>
                </div>

                <!-- Stats Cards with Visual Enhancements -->
                <div class="stats-grid">
                    <div class="stat-card clickable-card" data-view="users" title="Click to manage users">
                        <div class="stat-icon">
                            <i class="fa-solid fa-users"></i>
                        </div>
                        <h3><i class="fa-solid fa-user-plus"></i> Total Users</h3>
                        <div class="value">
                            <span id="stat-users">0</span>
                            <span id="stat-users-trend" class="trend up">
                                <i class="fa-solid fa-arrow-up"></i> --%
                            </span>
                        </div>
                        <div class="label">
                            All time users
                            <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>

                    <div class="stat-card clickable-card" data-view="markets" title="Click to manage markets">
                        <div class="stat-icon bg-[#2196f3] shadow-[0_4px_12px_rgba(33,150,243,0.3)]">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <h3><i class="fa-solid fa-chart-simple"></i> Active Markets</h3>
                        <div class="value">
                            <span id="stat-markets">0</span>
                            <span id="stat-markets-trend" class="trend up">
                                <i class="fa-solid fa-arrow-up"></i> --%
                            </span>
                        </div>
                        <div class="label">
                            Live markets now
                            <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>

                    <div class="stat-card clickable-card" data-view="transactions" title="Click to view transactions">
                        <div class="stat-icon bg-[#ff9800] shadow-[0_4px_12px_rgba(255,152,0,0.3)]">
                            <i class="fa-solid fa-receipt"></i>
                        </div>
                        <h3><i class="fa-solid fa-coins"></i> Transactions</h3>
                        <div class="value">
                            <span id="stat-transactions">0</span>
                            <span id="stat-transactions-trend" class="trend up">
                                <i class="fa-solid fa-arrow-up"></i> --%
                            </span>
                        </div>
                        <div class="label">
                            Last 30 days
                            <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>

                    <div class="stat-card clickable-card" data-view="messages" title="Click to view messages">
                        <div class="stat-icon bg-[#9c27b0] shadow-[0_4px_12px_rgba(156,39,176,0.3)]">
                            <i class="fa-solid fa-envelope"></i>
                        </div>
                        <h3><i class="fa-solid fa-message"></i> Messages</h3>
                        <div class="value">
                            <span id="stat-messages">0</span>
                            <span id="stat-messages-trend" class="trend down">
                                <i class="fa-solid fa-arrow-down"></i> --%
                            </span>
                        </div>
                        <div class="label">
                            Last 30 days
                            <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3><i class="fa-solid fa-chart-area"></i> Activity Overview</h3>
                        <canvas id="activityChart" class="max-h-[300px]"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3><i class="fa-solid fa-chart-pie"></i> Market Distribution</h3>
                        <canvas id="marketChart" class="max-h-[300px]"></canvas>
                    </div>
                </div>

                <!-- Recent Activity Feed -->
                <div class="activity-feed">
                    <h3><i class="fa-solid fa-clock-rotate-left"></i> Recent Activity</h3>
                    <div id="activity-list">
                        <!-- Loading skeleton -->
                        <div class="skeleton-list">
                            <div class="skeleton skeleton-card"></div>
                            <div class="skeleton skeleton-card"></div>
                            <div class="skeleton skeleton-card"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Markets Panel -->
            <section class="tabpanel" id="marketsPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-chart-simple"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Markets Management</h2>
                        <p>Create and manage prediction markets with live preview</p>
                    </div>
                </div>

                <!-- Market Tabs -->
                <div class="market-tabs">
                    <button class="market-tab active" data-tab="create">
                        <i class="fa-solid fa-plus-circle"></i> Create Market
                    </button>
                    <button class="market-tab" data-tab="all">
                        <i class="fa-solid fa-list"></i> All Markets
                    </button>
                </div>

                <!-- Create Market Tab -->
                <div id="createMarketTab" class="market-tab-content active">
                    <div class="market-creation-grid">
                        <!-- Left: Live Preview -->
                        <div class="market-preview-container">
                            <div class="market-preview-header">
                                <h3 class="market-preview-title">
                                    <i class="fa-solid fa-eye"></i> Live Preview
                                </h3>
                            </div>
                            <div class="market-preview-wrapper">
                                <div class="preview-market-card" id="marketPreviewCard">
                                    <div class="preview-market-image" id="previewImage">
                                        <i class="fa-solid fa-image"></i>
                                    </div>
                                    <div class="preview-market-content">
                                        <div class="preview-market-header">
                                            <div class="flex-1">
                                                <h3 class="preview-market-title" id="previewTitle">Market Title</h3>
                                                <span class="preview-market-category" id="previewCategory">SPORTS</span>
                                            </div>
                                        </div>
                                        <p class="preview-market-description" id="previewDescription">
                                            Market description will appear here...
                                        </p>
                                        <div class="preview-market-options" id="previewOptions">
                                            <div class="preview-option">
                                                <div class="preview-option-label">YES</div>
                                                <div class="preview-option-odds">50%</div>
                                            </div>
                                            <div class="preview-option">
                                                <div class="preview-option-label">NO</div>
                                                <div class="preview-option-odds">50%</div>
                                            </div>
                                        </div>
                                        <div id="previewSuggestedOdds" class="mt-2 text-xs text-gray-400">
                                            Suggested opening odds:
                                            <span class="text-green-400 font-semibold">YES</span>
                                            <span id="previewSuggestedOddsYes" class="text-gray-200 font-semibold">--</span>
                                            <span class="text-gray-500">/</span>
                                            <span class="text-red-400 font-semibold">NO</span>
                                            <span id="previewSuggestedOddsNo" class="text-gray-200 font-semibold">--</span>
                                        </div>
                                        <div class="preview-market-meta">
                                            <div class="preview-market-volume">
                                                Volume: <strong id="previewVolume">$0</strong>
                                            </div>
                                            <div class="preview-market-traders">
                                                <i class="fa-solid fa-users"></i>
                                                <span id="previewTraders">0 traders</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Creation Form -->
                        <div class="market-form-container">
                            <form id="createMarketForm">
                                <!-- Basic Information -->
                                <div class="market-form-section">
                                    <h4 class="market-form-section-title">
                                        <i class="fa-solid fa-info-circle"></i> Basic Information
                                    </h4>

                                    <div class="market-form-group">
                                        <label class="market-form-label required" for="marketTitle">Market Title</label>
                                        <input
                                            type="text"
                                            class="market-form-input"
                                            id="marketTitle"
                                            placeholder="e.g., Will the Lakers win the championship?"
                                            required
                                            oninput="updatePreview()"
                                        >
                                        <div class="market-form-help">Keep it clear and concise</div>
                                    </div>

                                    <div class="market-form-group">
                                        <div class="market-form-label required">Description</div>
                                        <div id="marketDescriptionEditor" class="bg-admin-bg border-2 border-admin-border rounded-lg min-h-[240px]"></div>
                                        <div class="market-form-help">Explain the market conditions clearly - supports rich text formatting</div>
                                    </div>

                                    <div class="market-form-group">
                                        <label class="market-form-label required" for="marketCategory">Category</label>
                                        <select
                                            class="market-form-select"
                                            id="marketCategory"
                                            required
                                            onchange="updatePreview()"
                                        >
                                            <option value="">Select category...</option>
                                            <option value="Jamaican Parliament">Jamaican Parliament</option>
                                            <option value="Dancehall">Dancehall</option>
                                            <option value="Reggae">Reggae</option>
                                            <option value="Jamaica Sports">Jamaica Sports</option>
                                            <option value="Caribbean Cricket">Caribbean Cricket</option>
                                            <option value="Jamaica Business">Jamaica Business</option>
                                            <option value="JMD & Crypto">JMD & Crypto</option>
                                            <option value="Jamaican Culture">Jamaican Culture</option>
                                            <option value="Caribbean News">Caribbean News</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Market Image -->
                                <div class="market-form-section">
                                    <h4 class="market-form-section-title">
                                        <i class="fa-solid fa-image"></i> Market Image
                                    </h4>

                                    <div class="market-form-group">
                                        <div class="market-image-upload">
                                            <label class="market-image-upload-btn">
                                                <input
                                                    type="file"
                                                    id="marketImage"
                                                    accept="image/*"
                                                    onchange="handleImageUpload(event)"
                                                >
                                                <i class="fa-solid fa-cloud-arrow-up"></i>
                                                <span>Click to upload image</span>
                                                <small class="text-gray-500">PNG, JPG up to 5MB</small>
                                            </label>
                                        </div>
                                        <div class="market-form-help">Upload a relevant image for the market</div>
                                    </div>
                                </div>

                                <!-- Market Options -->
                                <div class="market-form-section">
                                    <h4 class="market-form-section-title">
                                        <i class="fa-solid fa-list-check"></i> Market Options
                                    </h4>

                                    <div class="market-options-container" id="marketOptionsContainer">
                                        <div class="market-option-group">
                                            <input
                                                type="text"
                                                class="market-form-input market-option-input"
                                                name="marketOption1"
                                                placeholder="Option 1 (e.g., YES)"
                                                value="YES"
                                                required
                                                oninput="updatePreview()"
                                            >
                                        </div>
                                        <div class="market-option-group">
                                            <input
                                                type="text"
                                                class="market-form-input market-option-input"
                                                name="marketOption2"
                                                placeholder="Option 2 (e.g., NO)"
                                                value="NO"
                                                required
                                                oninput="updatePreview()"
                                            >
                                        </div>
                                    </div>
                                    <div class="market-form-group mt-3">
                                        <label class="market-form-label" for="openingOddsYes">Opening Odds (Optional)</label>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="text-[11px] text-gray-500" for="openingOddsYes">YES odds</label>
                                                <input
                                                    type="number"
                                                    class="market-form-input"
                                                    id="openingOddsYes"
                                                    name="opening_odds_yes"
                                                    placeholder="e.g., 1.60"
                                                    min="1.01"
                                                    step="0.01"
                                                    oninput="updatePreview()"
                                                >
                                            </div>
                                            <div>
                                                <label class="text-[11px] text-gray-500" for="openingOddsNo">NO odds</label>
                                                <input
                                                    type="number"
                                                    class="market-form-input"
                                                    id="openingOddsNo"
                                                    name="opening_odds_no"
                                                    placeholder="e.g., 2.70"
                                                    min="1.01"
                                                    step="0.01"
                                                    oninput="updatePreview()"
                                                >
                                            </div>
                                        </div>
                                        <div class="market-form-help">Leave blank for even 2.00x / 2.00x. Odds are the payout multiplier users see on launch.</div>
                                        <button type="button" class="btn secondary btn-sm mt-2" id="useSuggestedOddsBtn">
                                            Use suggested odds
                                        </button>
                                    </div>
                                    <div id="market-odds-suggestion" class="mt-3 rounded-lg border border-admin-border bg-admin-bg2 p-3 text-xs text-gray-400">
                                        <div class="flex items-center justify-between gap-2">
                                            <div class="font-semibold text-white">Suggested opening odds</div>
                                            <div class="text-[11px] text-gray-500" id="market-odds-source">Loading guidance...</div>
                                        </div>
                                        <div class="mt-2 flex items-center gap-3">
                                            <div class="flex items-center gap-2 rounded-md bg-black/30 px-2 py-1">
                                                <span class="text-green-400 font-semibold">YES</span>
                                                <span id="market-odds-yes" class="text-gray-200 font-semibold">--</span>
                                            </div>
                                            <div class="flex items-center gap-2 rounded-md bg-black/30 px-2 py-1">
                                                <span class="text-red-400 font-semibold">NO</span>
                                                <span id="market-odds-no" class="text-gray-200 font-semibold">--</span>
                                            </div>
                                        </div>
                                        <div class="mt-2 text-[11px] text-gray-500" id="market-odds-analysis">
                                            We will fill this with odds insight from the guidance feed.
                                        </div>
                                    </div>

                                    <button
                                        type="button"
                                        class="market-add-option"
                                        id="addMarketOptionBtn"
                                    >
                                        <i class="fa-solid fa-plus"></i> Add Another Option
                                    </button>
                                    <div class="market-form-help">Minimum 2 options required</div>
                                </div>

                                <!-- Market Settings -->
                                <div class="market-form-section">
                                    <h4 class="market-form-section-title">
                                        <i class="fa-solid fa-gear"></i> Market Settings
                                    </h4>

                                    <div class="market-form-group">
                                        <label class="market-form-label required" for="marketResolutionDate">Resolution Date</label>
                                        <input
                                            type="datetime-local"
                                            class="market-form-input"
                                            id="marketResolutionDate"
                                            required
                                        >
                                        <div class="market-form-help">When will this market resolve?</div>
                                    </div>

                                    <div class="market-form-group">
                                        <label class="market-form-label" for="marketLiquidity">Initial Liquidity (Optional)</label>
                                        <input
                                            type="number"
                                            class="market-form-input"
                                            id="marketLiquidity"
                                            placeholder="0"
                                            min="0"
                                            step="0.01"
                                        >
                                        <div class="market-form-help">Starting pool size. Higher = steadier prices, lower = more volatile.</div>
                                        <div id="liquidity-guidance" class="mt-2 rounded-lg border border-admin-border bg-admin-bg2 p-3 text-xs text-gray-300">
                                            <div class="text-[11px] uppercase tracking-wide text-gray-500">Suggested by Odds API</div>
                                            <div class="mt-2 flex items-center justify-between gap-3">
                                                <div>
                                                    <div class="text-sm font-semibold text-white" id="liquidity-suggestion">--</div>
                                                    <div class="text-[11px] text-gray-500" id="liquidity-suggestion-note">Select a category to get a suggestion.</div>
                                                </div>
                                                <button type="button" class="btn secondary btn-sm" id="useLiquiditySuggestionBtn">Use suggestion</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="market-form-group">
                                        <label class="market-form-label" for="marketFee">Market Fee (%)</label>
                                        <input
                                            type="number"
                                            class="market-form-input"
                                            id="marketFee"
                                            placeholder="2"
                                            min="0"
                                            max="10"
                                            step="0.1"
                                            value="2"
                                        >
                                        <div class="market-form-help">Trading fee percentage (0-10%)</div>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="market-form-actions">
                                    <button type="button" class="market-cancel-btn" id="resetMarketBtn">
                                        <i class="fa-solid fa-times"></i> Reset
                                    </button>
                                    <button type="submit" class="market-submit-btn">
                                        <i class="fa-solid fa-rocket"></i> Create Market
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- All Markets Tab -->
                <div id="allMarketsTab" class="market-tab-content">
                    <div class="flex justify-end mb-4">
                        <button type="button" class="btn secondary" id="cleanMarketDescriptionsBtn">
                            <i class="fa-solid fa-broom"></i> Clean Descriptions
                        </button>
                    </div>
                    <div id="admin-content-markets">
                        <div class="skeleton-list">
                            <div class="skeleton skeleton-card"></div>
                            <div class="skeleton skeleton-card"></div>
                            <div class="skeleton skeleton-card"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Banners Panel -->
            <section class="tabpanel" id="bannersPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-image"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Banner Management</h2>
                        <p>1:1 preview and position control</p>
                    </div>
                </div>

                <!-- Main Banner Editor -->
                <div class="banner-editor-grid">
                    <!-- Left: Live Preview -->
                    <div class="banner-preview-section">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-admin-accent text-base font-semibold m-0">
                                <i class="fa-solid fa-eye"></i> Live Site Preview
                            </h3>
                            <!-- Preview Mode Toggle -->
                            <div class="flex gap-2 bg-admin-bg2 rounded-lg p-1">
                                <button id="desktopModeBtn" class="banner-quick-btn active px-4 py-2">
                                    <i class="fa-solid fa-desktop"></i> Desktop
                                </button>
                                <button id="mobileModeBtn" class="banner-quick-btn px-4 py-2">
                                    <i class="fa-solid fa-mobile-screen-button"></i> Mobile
                                </button>
                            </div>
                        </div>
                        <div class="banner-preview-wrapper">
                            <!-- Mock Header -->
                            <div class="banner-mock-header">
                                <div class="banner-mock-logo"></div>
                                <div class="flex-1 font-bold text-[#FFD700] text-lg">GoatMouth</div>
                            </div>

                            <!-- Mock Navigation -->
                            <div class="banner-mock-nav">
                                <div class="banner-mock-nav-item">Markets</div>
                                <div class="banner-mock-nav-item">Activity</div>
                                <div class="banner-mock-nav-item">Leaderboard</div>
                            </div>

                            <!-- BANNER CONTAINER (1:1 exact size) -->
                            <div id="bannerLivePreview" class="banner-live-container">
                                <div class="flex items-center justify-center h-full text-gray-500 text-center">
                                    <div>
                                        <i class="fa-solid fa-image text-3xl mb-2 opacity-30"></i>
                                        <p class="text-[13px]">Select or upload a banner to preview</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Mock Market Cards -->
                            <div class="banner-mock-market-grid">
                                <div class="banner-mock-market-card"></div>
                                <div class="banner-mock-market-card"></div>
                                <div class="banner-mock-market-card"></div>
                            </div>
                        </div>

                        <!-- Position Info -->
                        <div class="flex gap-3 mt-3">
                            <div class="flex-1 bg-admin-bg2 border border-admin-border rounded-lg p-3">
                                <div class="text-[11px] text-gray-500 mb-1">HORIZONTAL</div>
                                <div id="posXDisplay" class="text-lg font-bold text-admin-accent">50%</div>
                            </div>
                            <div class="flex-1 bg-admin-bg2 border border-admin-border rounded-lg p-3">
                                <div class="text-[11px] text-gray-500 mb-1">VERTICAL</div>
                                <div id="posYDisplay" class="text-lg font-bold text-admin-accent">50%</div>
                            </div>
                            <div class="flex-1 bg-admin-bg2 border border-admin-border rounded-lg p-3">
                                <div class="text-[11px] text-gray-500 mb-1">STATUS</div>
                                <div id="bannerStatus" class="text-lg font-bold text-green-400">Ready</div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Control Panel -->
                    <div class="banner-control-panel">
                        <h3 class="text-base font-bold text-white mb-5">
                            <i class="fa-solid fa-sliders"></i> Quick Controls
                        </h3>

                        <!-- Upload Section -->
                        <div class="banner-control-section">
                            <label class="banner-control-label" for="bannerUploadInput">Upload Banner</label>
                            <input type="file" id="bannerUploadInput" accept="image/*" class="hidden">
                            <button class="btn w-full justify-center" id="bannerUploadBtn">
                                <i class="fa-solid fa-cloud-arrow-up"></i> Choose Image
                            </button>
                            <div id="uploadInfo" class="mt-2 text-[11px] text-gray-500 text-center">
                                Recommended: 1920??100px
                            </div>
                        </div>

                        <!-- Position Presets -->
                        <div class="banner-control-section">
                            <div class="banner-control-label">Position Presets</div>
                            <div class="banner-quick-actions">
                                <button class="banner-quick-btn" data-position="top">
                                    <i class="fa-solid fa-arrow-up"></i> Top
                                </button>
                                <button class="banner-quick-btn active" data-position="center">
                                    <i class="fa-solid fa-circle-dot"></i> Center
                                </button>
                                <button class="banner-quick-btn" data-position="bottom">
                                    <i class="fa-solid fa-arrow-down"></i> Bottom
                                </button>
                            </div>
                        </div>

                        <!-- Fine Tune -->
                        <div class="banner-control-section">
                            <div class="banner-control-label">Fine Tune</div>
                            <div class="grid grid-cols-3 gap-2">
                                <button class="banner-quick-btn col-start-2" data-direction="up">
                                    <i class="fa-solid fa-chevron-up"></i>
                                </button>
                                <button class="banner-quick-btn" data-direction="left">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </button>
                                <button class="banner-quick-btn" data-position="center" title="Reset">
                                    <i class="fa-solid fa-rotate-right"></i>
                                </button>
                                <button class="banner-quick-btn" data-direction="right">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </button>
                                <button class="banner-quick-btn col-start-2" data-direction="down">
                                    <i class="fa-solid fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Image Fit -->
                        <div class="banner-control-section">
                            <div class="banner-control-label">How Image Fills Container</div>
                            <div class="grid gap-2">
                                <button class="banner-quick-btn active text-left p-3" id="fit-cover">
                                    <div class="font-bold mb-0.5">Cover (Recommended)</div>
                                    <div class="text-[10px] opacity-70">Fills container, crops if needed</div>
                                </button>
                                <button class="banner-quick-btn text-left p-3" id="fit-contain">
                                    <div class="font-bold mb-0.5">Contain</div>
                                    <div class="text-[10px] opacity-70">Shows full image, may have empty space</div>
                                </button>
                                <button class="banner-quick-btn text-left p-3" id="fit-fill">
                                    <div class="font-bold mb-0.5">Stretch to Fill</div>
                                    <div class="text-[10px] opacity-70">Stretches to fit exactly</div>
                                </button>
                                <button class="banner-quick-btn text-left p-3" id="fit-none">
                                    <div class="font-bold mb-0.5">Original Size</div>
                                    <div class="text-[10px] opacity-70">No scaling, use position controls</div>
                                </button>
                            </div>
                        </div>

                        <!-- Image Scale (for 'none' fit type) -->
                        <div class="banner-control-section hidden" id="scaleControls">
                            <label class="banner-control-label" for="imageScale">Image Scale</label>
                            <input type="range" id="imageScale" min="50" max="200" value="100" step="10"
                                   class="w-full mb-2"
                                   oninput="updateImageScale(this.value)">
                            <div class="text-center text-xs text-gray-500">
                                Scale: <span id="scaleValue">100</span>%
                            </div>
                        </div>

                        <!-- Save Actions -->
                        <div class="banner-control-section">
                            <button class="btn w-full justify-center bg-green-400" id="saveBannerBtn">
                                <i class="fa-solid fa-floppy-disk"></i> Save Banner
                            </button>
                            <button class="btn secondary w-full justify-center mt-2" id="clearBannerBtn">
                                <i class="fa-solid fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Debug Info -->
                <div class="bg-admin-bg2 border border-admin-border rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-[13px] font-semibold text-gray-500 uppercase">
                            <i class="fa-solid fa-bug"></i> System Status
                        </h4>
                        <button class="btn secondary btn-sm" id="checkSystemStatusBtn">
                            <i class="fa-solid fa-rotate"></i> Check
                        </button>
                    </div>
                    <div id="systemStatus" class="font-mono text-[11px] text-gray-500">
                        Click "Check" to view system status
                    </div>
                </div>

                <!-- Banner List -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-base font-semibold text-white">
                            <i class="fa-solid fa-list"></i> Your Banners
                        </h3>
                        <div class="flex items-center gap-2">
                            <button class="btn secondary btn-sm" id="cleanInvalidBannerUrlsBtn">
                                <i class="fa-solid fa-broom"></i> Clean Invalid URLs
                            </button>
                            <button class="btn secondary" data-action="load-banner-list">
                                <i class="fa-solid fa-rotate"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div id="bannerListContainer">
                        <div class="skeleton-list">
                            <div class="skeleton skeleton-card"></div>
                            <div class="skeleton skeleton-card"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Voting Hero Panel -->
            <section class="tabpanel" id="votingHeroPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-vote-yea"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Voting Hero Background</h2>
                        <p>Upload background image for voting page hero section</p>
                    </div>
                </div>

                <div class="max-w-[800px] mt-6">
                    <!-- Current Image Preview -->
                    <div class="bg-admin-bg2 border border-admin-border rounded-xl p-6 mb-6">
                        <h3 class="text-admin-accent mb-4 text-base font-semibold">
                            <i class="fa-solid fa-image"></i> Current Background
                        </h3>
                        <div id="votingHeroPreview" class="w-full h-[200px] bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg bg-cover bg-center flex items-center justify-center text-gray-500">
                            <div class="text-center">
                                <i class="fa-solid fa-image text-5xl opacity-30 mb-3"></i>
                                <p>No background image set</p>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Section -->
                    <div class="bg-admin-bg2 border border-admin-border rounded-xl p-6">
                        <h3 class="text-admin-accent mb-4 text-base font-semibold">
                            <i class="fa-solid fa-cloud-arrow-up"></i> Upload New Background
                        </h3>
                        <input type="file" id="votingHeroUpload" accept="image/*" class="hidden">
                        <button class="btn w-full justify-center mb-4" id="votingHeroUploadBtn">
                            <i class="fa-solid fa-cloud-arrow-up"></i> Choose Image
                        </button>
                        <div class="flex gap-3">
                            <button class="btn secondary flex-1 justify-center" id="saveVotingHeroBtn">
                                <i class="fa-solid fa-save"></i> Save
                            </button>
                            <button class="btn secondary flex-1 justify-center" id="removeVotingHeroBtn">
                                <i class="fa-solid fa-trash"></i> Remove
                            </button>
                        </div>
                        <div id="votingHeroStatus" class="mt-4 text-sm"></div>
                    </div>
                </div>
            </section>

            <!-- Users Panel -->
            <section class="tabpanel" id="usersPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-users"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Users</h2>
                        <p>Manage user accounts</p>
                    </div>
                </div>
                <div id="admin-content-users">
                    <div class="skeleton-list">
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- Activity Panel -->
            <section class="tabpanel" id="activityPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Site Activity</h2>
                        <p>View all recent site activity</p>
                    </div>
                </div>
                <div id="admin-content-activity">
                    <div class="skeleton-list">
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- Transactions Panel -->
            <section class="tabpanel" id="transactionsPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-receipt"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Transactions</h2>
                        <p>View transaction history</p>
                    </div>
                </div>
                <div id="admin-content-transactions">
                    <div class="skeleton-list">
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- Messages Panel -->
            <section class="tabpanel" id="messagesPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-envelope"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Messages</h2>
                        <p>Contact form submissions</p>
                    </div>
                </div>
                <div id="admin-content-messages">
                    <div class="skeleton-list">
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- Voting Panel -->
            <section class="tabpanel" id="votingPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-check-circle"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Voting</h2>
                        <p>Manage community proposals</p>
                    </div>
                </div>
                <div id="admin-content-voting">
                    <div class="skeleton-list">
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- API & Insights Panel -->
            <section class="tabpanel" id="apiPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-signal"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>API & Insights</h2>
                        <p>ML Controls, Odds API health, Market analytics, and guidance insights</p>
                    </div>
                </div>

                <div id="admin-content-api" class="p-1">
                    <!-- API Health Status -->
                    <div class="card mb-5">
                        <h3 class="flex items-center gap-2.5 mb-[15px]">
                            <i class="fa-solid fa-heart-pulse text-admin-accent"></i>
                            API Health Status
                        </h3>
                        <div class="grid grid-cols-[repeat(auto-fit,minmax(200px,1fr))] gap-[15px]">
                            <div class="stat-card">
                                <div class="stat-value" id="api-status">
                                    <i class="fa-solid fa-circle-notch fa-spin"></i>
                                </div>
                                <div class="stat-label">Status</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="api-uptime">--</div>
                                <div class="stat-label">Uptime</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="api-response-time">--</div>
                                <div class="stat-label">Avg Response Time</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="api-requests">--</div>
                                <div class="stat-label">Total Requests (24h)</div>
                            </div>
                        </div>
                        <div class="mt-[15px] flex gap-2.5">
                            <button class="btn secondary" id="run-health-check">
                                <i class="fa-solid fa-heart-pulse"></i> Run Health Check
                            </button>
                            <button class="btn secondary" id="refresh-api-stats">
                                <i class="fa-solid fa-rotate"></i> Refresh Stats
                            </button>
                        </div>
                    </div>

                    <!-- ML Controls Section -->
                    <div class="card mb-5">
                        <h3 class="flex items-center gap-2.5 mb-[15px]">
                            <i class="fa-solid fa-brain text-[#9c27b0]"></i>
                            Machine Learning Controls
                        </h3>

                        <div class="grid gap-5">
                            <!-- Model Configuration -->
                            <div>
                                <h4 class="mb-2.5 text-admin-fg text-sm">
                                    <i class="fa-solid fa-sliders"></i> Model Configuration
                                </h4>
                                <div class="grid grid-cols-[repeat(auto-fit,minmax(250px,1fr))] gap-[15px]">
                                    <div>
                                        <label class="form-label" for="ml-house-margin">House Margin (%)</label>
                                        <input type="number" id="ml-house-margin" class="form-input" min="0" max="10" step="0.1" value="2.0">
                                        <small class="text-gray-500 text-[11px]">Platform fee percentage</small>
                                    </div>
                                    <div>
                                        <label class="form-label" for="ml-pool-size">Default Pool Size</label>
                                        <input type="number" id="ml-pool-size" class="form-input" min="100" max="10000" step="100" value="1000">
                                        <small class="text-gray-500 text-[11px]">Liquidity pool initialization</small>
                                    </div>
                                    <div>
                                        <label class="form-label" for="ml-volatility">Volatility Factor</label>
                                        <input type="number" id="ml-volatility" class="form-input" min="0" max="2" step="0.05" value="1.0">
                                        <small class="text-gray-500 text-[11px]">Price sensitivity multiplier</small>
                                    </div>
                                    <div>
                                        <label class="form-label" for="ml-min-liquidity">Min Liquidity Threshold</label>
                                        <input type="number" id="ml-min-liquidity" class="form-input" min="10" max="500" step="10" value="100">
                                        <small class="text-gray-500 text-[11px]">Minimum pool balance</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Feature Weights -->
                            <div>
                                <h4 class="mb-2.5 text-admin-fg text-sm">
                                    <i class="fa-solid fa-weight-scale"></i> Feature Weights
                                </h4>
                                <div class="grid grid-cols-[repeat(auto-fit,minmax(250px,1fr))] gap-[15px]">
                                    <div>
                                        <label class="form-label" for="ml-volume-weight">Volume Weight</label>
                                        <input type="range" id="ml-volume-weight" min="0" max="100" value="40"
                                               class="w-full" oninput="document.getElementById('volume-weight-val').textContent = this.value + '%'">
                                        <div class="flex justify-between text-[11px] text-gray-500">
                                            <span>0%</span>
                                            <span id="volume-weight-val">40%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label" for="ml-momentum-weight">Momentum Weight</label>
                                        <input type="range" id="ml-momentum-weight" min="0" max="100" value="30"
                                               class="w-full" oninput="document.getElementById('momentum-weight-val').textContent = this.value + '%'">
                                        <div class="flex justify-between text-[11px] text-gray-500">
                                            <span>0%</span>
                                            <span id="momentum-weight-val">30%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label" for="ml-sentiment-weight">Sentiment Weight</label>
                                        <input type="range" id="ml-sentiment-weight" min="0" max="100" value="20"
                                               class="w-full" oninput="document.getElementById('sentiment-weight-val').textContent = this.value + '%'">
                                        <div class="flex justify-between text-[11px] text-gray-500">
                                            <span>0%</span>
                                            <span id="sentiment-weight-val">20%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label" for="ml-time-weight">Time Decay Weight</label>
                                        <input type="range" id="ml-time-weight" min="0" max="100" value="10"
                                               class="w-full" oninput="document.getElementById('time-weight-val').textContent = this.value + '%'">
                                        <div class="flex justify-between text-[11px] text-gray-500">
                                            <span>0%</span>
                                            <span id="time-weight-val">10%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Model Actions -->
                            <div class="flex gap-2.5 flex-wrap">
                                <button class="btn primary" id="save-ml-config">
                                    <i class="fa-solid fa-save"></i> Save Configuration
                                </button>
                                <button class="btn secondary" id="reset-ml-config">
                                    <i class="fa-solid fa-rotate-left"></i> Reset to Defaults
                                </button>
                                <button class="btn secondary" id="test-ml-model">
                                    <i class="fa-solid fa-flask"></i> Test Model
                                </button>
                                <button class="btn bg-[#607d8b] text-white" id="export-ml-config">
                                    <i class="fa-solid fa-download"></i> Export Config
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Market Analytics -->
                    <div class="card mb-5">
                        <h3 class="flex items-center gap-2.5 mb-[15px]">
                            <i class="fa-solid fa-chart-line text-[#2196f3]"></i>
                            Market Analytics & Insights
                        </h3>

                        <div class="grid grid-cols-[repeat(auto-fit,minmax(150px,1fr))] gap-2.5 mb-5">
                            <div class="stat-card bg-gradient-to-br from-[#667eea] to-[#764ba2]">
                                <div class="stat-value" id="total-markets-stat">--</div>
                                <div class="stat-label">Total Markets</div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-[#f093fb] to-[#f5576c]">
                                <div class="stat-value" id="active-markets-stat">--</div>
                                <div class="stat-label">Active Markets</div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-[#4facfe] to-[#00f2fe]">
                                <div class="stat-value" id="total-volume-stat">--</div>
                                <div class="stat-label">Total Volume (24h)</div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-[#43e97b] to-[#38f9d7]">
                                <div class="stat-value" id="total-bets-stat">--</div>
                                <div class="stat-label">Total Bets (24h)</div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-[#fa709a] to-[#fee140]">
                                <div class="stat-value" id="avg-odds-stat">--</div>
                                <div class="stat-label">Avg Odds</div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-[#30cfd0] to-[#330867]">
                                <div class="stat-value" id="liquidity-stat">--</div>
                                <div class="stat-label">Total Liquidity</div>
                            </div>
                        </div>

                        <!-- Top Markets Table -->
                        <div>
                            <h4 class="mb-2.5 text-admin-fg text-sm">
                                <i class="fa-solid fa-fire"></i> Top Performing Markets
                            </h4>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="border-b-2 border-admin-border">
                                            <th class="p-2.5 text-left text-xs text-gray-500">Market</th>
                                            <th class="p-2.5 text-left text-xs text-gray-500">Volume</th>
                                            <th class="p-2.5 text-left text-xs text-gray-500">Bets</th>
                                            <th class="p-2.5 text-left text-xs text-gray-500">YES Price</th>
                                            <th class="p-2.5 text-left text-xs text-gray-500">Liquidity</th>
                                            <th class="p-2.5 text-left text-xs text-gray-500">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="top-markets-table">
                                        <tr>
                                            <td colspan="6" class="p-5 text-center text-gray-500">
                                                <i class="fa-solid fa-spinner fa-spin"></i> Loading market data...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="mt-[15px]">
                            <button class="btn secondary" id="refresh-market-analytics">
                                <i class="fa-solid fa-rotate"></i> Refresh Analytics
                            </button>
                            <button class="btn secondary ml-2.5" id="export-market-data">
                                <i class="fa-solid fa-file-export"></i> Export Data
                            </button>
                        </div>
                    </div>

                    <!-- Telemetry & Logs -->
                    <div class="card">
                        <h3 class="flex items-center gap-2.5 mb-[15px]">
                            <i class="fa-solid fa-terminal text-[#ff9800]"></i>
                            API Telemetry & Logs
                        </h3>
                        <div id="telemetry-logs" style="background: #000; color: #0f0; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 300px; overflow-y: auto;">
                            <div class="text-[#888]">Waiting for telemetry data...</div>
                        </div>
                        <div class="mt-2.5 flex gap-2.5">
                            <button class="btn secondary" id="clear-logs">
                                <i class="fa-solid fa-trash"></i> Clear Logs
                            </button>
                            <button class="btn secondary" id="download-logs">
                                <i class="fa-solid fa-download"></i> Download Logs
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Status Bar -->
    <div class="statusbar">
        <div>
            <i class="fa-solid fa-circle text-green-400 text-[8px]"></i>
            <span>GoatMouth Admin Panel</span>
        </div>
        <div id="status-info">Ready</div>
    </div>

    <!-- Modal Container -->
    <div id="modal-root"></div>

    <!-- Scripts -->
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="js/supabase-client.js?v=4.6"></script>
    <script defer src="js/sanitize-helper.js?v=4.6"></script>
    <script defer src="js/toast.js?v=4.6"></script>
    <script defer src="js/api.js?v=4.6"></script>
    <script type="module" src="js/utils-loader.js?v=4.6"></script>

    <script defer src="js/shared-components.js?v=4.6"></script>
    <script defer src="js/auth-guard.js?v=4.6"></script>
    <script defer src="js/admin-ui.js?v=4.6"></script>
    <script defer src="js/admin-banners.js?v=4.6"></script>
    <script defer src="js/admin.js?v=4.6"></script>
    <script defer src="js/admin-ml-insights.js?v=4.6"></script>

    <script>
        // Mobile menu toggle
        const hamburger = document.getElementById('hamburger');
        const menubar = document.querySelector('.menubar');
        const mobileOverlay = document.getElementById('mobileOverlay');

        function toggleMobileMenu() {
            if (hamburger) hamburger.classList.toggle('active');
            if (menubar) menubar.classList.toggle('active');
            if (mobileOverlay) mobileOverlay.classList.toggle('active');
            if (hamburger) {
                const expanded = hamburger.classList.contains('active');
                hamburger.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            }
        }

        function closeMobileMenu() {
            if (hamburger) hamburger.classList.remove('active');
            if (menubar) menubar.classList.remove('active');
            if (mobileOverlay) mobileOverlay.classList.remove('active');
            if (hamburger) {
                hamburger.setAttribute('aria-expanded', 'false');
            }
        }

        // Ensure inline handlers can access these in all browsers
        window.toggleMobileMenu = toggleMobileMenu;
        window.closeMobileMenu = closeMobileMenu;

        if (hamburger) hamburger.addEventListener('click', toggleMobileMenu);
        if (mobileOverlay) mobileOverlay.addEventListener('click', closeMobileMenu);

        // Close dropdown menus when clicking outside
        document.addEventListener('click', function(event) {
            // Close user dropdowns
            const userDropdowns = document.querySelectorAll('.user-dropdown-menu.show-dropdown');
            userDropdowns.forEach(dropdown => {
                const button = dropdown.previousElementSibling;
                if (!dropdown.contains(event.target) && !button.contains(event.target)) {
                    dropdown.classList.remove('show-dropdown');
                }
            });

            // Close message dropdowns
            const messageDropdowns = document.querySelectorAll('.message-dropdown-menu.show-dropdown');
            messageDropdowns.forEach(dropdown => {
                const button = dropdown.previousElementSibling;
                if (!dropdown.contains(event.target) && !button.contains(event.target)) {
                    dropdown.classList.remove('show-dropdown');
                }
            });
        });

        // View switching functionality
        function switchView(view, sourceButton) {
            // Close mobile menu
            closeMobileMenu();
            window.__pendingAdminView = view;
            if (view === 'banners') {
                window.__pendingBannerLoad = true;
            }

            // Remove active class from all buttons
            document.querySelectorAll('.menubar button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Add active class to clicked button
            const activeButton = sourceButton || document.querySelector(`.menubar button[data-view="${view}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // Hide all panels
            document.querySelectorAll('.tabpanel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Show selected panel
            const panelMap = {
                'dashboard': 'dashboardPanel',
                'markets': 'marketsPanel',
                'banners': 'bannersPanel',
                'voting-hero': 'votingHeroPanel',
                'users': 'usersPanel',
                  'activity': 'activityPanel',
                  'transactions': 'transactionsPanel',
                  'messages': 'messagesPanel',
                  'voting': 'votingPanel',
                  'api': 'apiPanel'
              };

            const panelId = panelMap[view];
            if (panelId) {
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.classList.add('active');
                }
            }

            // Update status bar
            const statusInfo = document.getElementById('status-info');
            if (statusInfo) {
                statusInfo.textContent = `Viewing: ${view.charAt(0).toUpperCase() + view.slice(1)}`;
            }

            if (view === 'dashboard' && typeof initDashboardCharts === 'function') {
                initDashboardCharts();
            }

            // Trigger actual data loading via adminPanel
            if (window.adminPanel) {
                window.adminPanel.switchView(view);
            }

            // Special handling for banners view
            if (view === 'banners') {
                console.log('Switching to banners view, will load banners in 500ms...');
                if (typeof loadBannerList === 'function') {
                    loadBannerList();
                }
                // Wait a bit for the view to render, then load banners
                setTimeout(() => {
                    console.log('Attempting to load banner list...');
                    loadBannerList().then(() => {
                        // Auto-load last selected banner if exists
                        const lastBannerId = localStorage.getItem('lastSelectedBannerId');
                        if (lastBannerId) {
                            console.log('Auto-loading last selected banner:', lastBannerId);
                            const bannerItems = document.querySelectorAll('.banner-list-item');
                            bannerItems.forEach(item => {
                                if (item.dataset.bannerId === lastBannerId) {
                                    item.click();
                                }
                            });
                        }
                    });
                }, 500);
            }
        }

        // Expose for debugging/use elsewhere
        window.switchView = switchView;

        window.addEventListener('adminPanelReady', () => {
            const pendingView = window.__pendingAdminView || 'dashboard';
            switchView(pendingView);

            if (pendingView === 'banners' && typeof loadBannerList === 'function') {
                loadBannerList();
            }
            if (window.__pendingBannerLoad && typeof loadBannerList === 'function') {
                loadBannerList();
                window.__pendingBannerLoad = false;
            }
            if (pendingView === 'markets' && window.__pendingMarketTab === 'all') {
                loadAllMarketsFromTab();
            }
        });

        // Initialize Dashboard Charts
        function initDashboardCharts() {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded yet; skipping dashboard charts.');
                return;
            }
            // Activity Overview Chart (Line Chart)
            const activityCtx = document.getElementById('activityChart');
            if (activityCtx) {
                new Chart(activityCtx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Users',
                            data: [45, 52, 48, 65, 72, 68, 85],
                            borderColor: '#1a4d2e',
                            backgroundColor: 'rgba(26, 77, 46, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Transactions',
                            data: [120, 135, 142, 158, 165, 178, 195],
                            borderColor: '#ff9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Markets',
                            data: [8, 10, 12, 11, 15, 14, 18],
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#D4D4D4',
                                    font: {
                                        size: 12,
                                        family: 'Inter'
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#666'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#666'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                }
                            }
                        }
                    }
                });
            }

            // Market Distribution Chart (Doughnut Chart)
            const marketCtx = document.getElementById('marketChart');
            if (marketCtx) {
                new Chart(marketCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Active', 'Pending', 'Closed', 'Resolved'],
                        datasets: [{
                            data: [45, 12, 28, 15],
                            backgroundColor: [
                                '#1a4d2e',
                                '#ff9800',
                                '#e53935',
                                '#2196f3'
                            ],
                            borderColor: '#1E1E1E',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#D4D4D4',
                                    font: {
                                        size: 12,
                                        family: 'Inter'
                                    },
                                    padding: 15
                                }
                            }
                        }
                    }
                });
            }
        }

        // Initialize charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            try {
                initDashboardCharts();
            } catch (error) {
                console.warn('Dashboard charts failed to initialize:', error);
            }
            try {
                initBannerEditor();
            } catch (error) {
                console.warn('Banner editor failed to initialize:', error);
            }
            // Activity feed is now loaded by admin.js renderDashboard()
        });

        function loadAllMarketsFromTab(retryCount = 0) {
            const container = document.getElementById('admin-content-markets');
            if (!container) return;

            if (window.adminPanel && window.adminPanel.api) {
                window.adminPanel.renderMarkets(container)
                    .catch(error => console.error('Failed to render markets:', error));
                return;
            }

            if (retryCount < 5) {
                setTimeout(() => loadAllMarketsFromTab(retryCount + 1), 400);
            }
        }

        function switchMarketTab(tab) {
            window.__pendingMarketTab = tab;
            document.querySelectorAll('.market-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            document.querySelectorAll('.market-tab-content').forEach(panel => {
                panel.classList.toggle('active', panel.id === (tab === 'all' ? 'allMarketsTab' : 'createMarketTab'));
            });

            if (tab === 'all') {
                loadAllMarketsFromTab();
            }
        }

        window.switchMarketTab = switchMarketTab;
        window.loadAllMarketsFromTab = loadAllMarketsFromTab;

        // Initialize Event Listeners
        function initEventListeners() {
            // Navigation and stat cards - event delegation for switchView
            document.addEventListener('click', (e) => {
                const viewBtn = e.target.closest('[data-view]');
                if (viewBtn) {
                    switchView(viewBtn.dataset.view);
                }
            });

            // Market tab switching
            document.addEventListener('click', (e) => {
                const tabBtn = e.target.closest('[data-tab]');
                if (tabBtn && tabBtn.classList.contains('market-tab')) {
                    switchMarketTab(tabBtn.dataset.tab);
                }
            });

            // Banner position buttons
            document.addEventListener('click', (e) => {
                const posBtn = e.target.closest('[data-position]');
                if (posBtn && posBtn.classList.contains('banner-quick-btn')) {
                    setBannerPosition(posBtn.dataset.position, posBtn);
                }
            });

            // Banner adjust position buttons
            document.addEventListener('click', (e) => {
                const dirBtn = e.target.closest('[data-direction]');
                if (dirBtn && dirBtn.classList.contains('banner-quick-btn')) {
                    adjustBannerPosition(dirBtn.dataset.direction);
                }
            });

            // Load banner list buttons
            document.addEventListener('click', (e) => {
                const loadBtn = e.target.closest('[data-action="load-banner-list"]');
                if (loadBtn) {
                    loadBannerList();
                }
            });

            // Remove market option buttons (event delegation for dynamic elements)
            document.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('[data-action="remove-option"]');
                if (removeBtn) {
                    removeMarketOption(removeBtn);
                }
            });

            // Banner list item selection (event delegation)
            document.addEventListener('click', (e) => {
                const bannerItem = e.target.closest('.banner-list-item');
                if (bannerItem && !e.target.closest('.delete-banner-btn')) {
                    selectBanner(
                        bannerItem.dataset.bannerId,
                        bannerItem.dataset.bannerUrl,
                        parseFloat(bannerItem.dataset.posX),
                        parseFloat(bannerItem.dataset.posY),
                        bannerItem.dataset.fit,
                        parseFloat(bannerItem.dataset.scale),
                        parseFloat(bannerItem.dataset.posXMobile),
                        parseFloat(bannerItem.dataset.posYMobile)
                    );
                }
            });

            // Delete banner buttons (event delegation with stopPropagation)
            document.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-banner-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    deleteBannerById(deleteBtn.dataset.bannerId);
                }
            });

            // Individual button event listeners
            const adminProfileBtn = document.getElementById('adminProfileBtn');
            const backToAppBtn = document.getElementById('backToAppBtn');
            const addMarketOptionBtn = document.getElementById('addMarketOptionBtn');
            const resetMarketBtn = document.getElementById('resetMarketBtn');
            const bannerUploadBtn = document.getElementById('bannerUploadBtn');
            const saveBannerBtn = document.getElementById('saveBannerBtn');
            const clearBannerBtn = document.getElementById('clearBannerBtn');
            const cleanInvalidBannerUrlsBtn = document.getElementById('cleanInvalidBannerUrlsBtn');
            const checkSystemStatusBtn = document.getElementById('checkSystemStatusBtn');
            const votingHeroUploadBtn = document.getElementById('votingHeroUploadBtn');
            const saveVotingHeroBtn = document.getElementById('saveVotingHeroBtn');
            const removeVotingHeroBtn = document.getElementById('removeVotingHeroBtn');
            const desktopModeBtn = document.getElementById('desktopModeBtn');
            const mobileModeBtn = document.getElementById('mobileModeBtn');
            const fitCover = document.getElementById('fit-cover');
            const fitContain = document.getElementById('fit-contain');
            const fitFill = document.getElementById('fit-fill');
            const fitNone = document.getElementById('fit-none');

            if (adminProfileBtn) {
                adminProfileBtn.addEventListener('click', () => window.adminPanel?.showAdminProfileModal());
            }
            if (backToAppBtn) backToAppBtn.addEventListener('click', () => window.location.href = 'index.html');
            if (addMarketOptionBtn && typeof addMarketOption === 'function') {
                addMarketOptionBtn.addEventListener('click', addMarketOption);
            }
            if (resetMarketBtn && typeof resetMarketForm === 'function') {
                resetMarketBtn.addEventListener('click', resetMarketForm);
            }
            if (bannerUploadBtn) bannerUploadBtn.addEventListener('click', () => document.getElementById('bannerUploadInput').click());
            if (saveBannerBtn && typeof saveBanner === 'function') saveBannerBtn.addEventListener('click', saveBanner);
            if (clearBannerBtn && typeof clearBanner === 'function') clearBannerBtn.addEventListener('click', clearBanner);
            if (cleanInvalidBannerUrlsBtn && typeof cleanInvalidBannerUrls === 'function') {
                cleanInvalidBannerUrlsBtn.addEventListener('click', cleanInvalidBannerUrls);
            }
            if (checkSystemStatusBtn && typeof checkSystemStatus === 'function') {
                checkSystemStatusBtn.addEventListener('click', checkSystemStatus);
            }
            if (votingHeroUploadBtn) votingHeroUploadBtn.addEventListener('click', () => document.getElementById('votingHeroUpload').click());
            if (saveVotingHeroBtn && typeof saveVotingHeroImage === 'function') {
                saveVotingHeroBtn.addEventListener('click', saveVotingHeroImage);
            }
            if (removeVotingHeroBtn && typeof removeVotingHeroImage === 'function') {
                removeVotingHeroBtn.addEventListener('click', removeVotingHeroImage);
            }
            if (desktopModeBtn && typeof switchPreviewMode === 'function') {
                desktopModeBtn.addEventListener('click', () => switchPreviewMode('desktop'));
            }
            if (mobileModeBtn && typeof switchPreviewMode === 'function') {
                mobileModeBtn.addEventListener('click', () => switchPreviewMode('mobile'));
            }
            if (fitCover && typeof setImageFit === 'function') fitCover.addEventListener('click', () => setImageFit('cover'));
            if (fitContain && typeof setImageFit === 'function') fitContain.addEventListener('click', () => setImageFit('contain'));
            if (fitFill && typeof setImageFit === 'function') fitFill.addEventListener('click', () => setImageFit('fill'));
            if (fitNone && typeof setImageFit === 'function') fitNone.addEventListener('click', () => setImageFit('none'));
        }

        // Banner Editor State
        let bannerState = {
            currentImage: null,
            posX: 50,
            posY: 50,
            posX_mobile: 50,
            posY_mobile: 50,
            fit: 'cover',
            scale: 100,
            isDragging: false,
            dragStartX: 0,
            dragStartY: 0,
            currentBannerId: null,
            previewMode: 'desktop' // 'desktop' or 'mobile'
        };

        function isValidBannerUrl(url) {
            if (typeof url !== 'string') return false;
            const trimmed = url.trim();
            if (!trimmed) return false;
            if (trimmed.includes('${') || trimmed.includes('%7B') || trimmed.includes('%7D')) return false;
            return true;
        }

        // Initialize Banner Editor
        function initBannerEditor() {
            const uploadInput = document.getElementById('bannerUploadInput');
            const preview = document.getElementById('bannerLivePreview');

            // Handle image upload
            if (uploadInput) {
                uploadInput.addEventListener('change', handleBannerUpload);
            }

            // Handle drag-and-drop on preview
            if (preview) {
                preview.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', handleDrag);
                document.addEventListener('mouseup', stopDrag);
            }

            // Don't auto-load on init - wait for user to switch to banners view
            // This will be handled by switchView function
        }

        // Handle Banner Upload
        function handleBannerUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                return;
            }

            // Read and display image
            const reader = new FileReader();
            reader.onload = function(e) {
                bannerState.currentImage = e.target.result;
                bannerState.currentBannerId = null; // New upload
                updateBannerPreview();

                // Update status
                document.getElementById('bannerStatus').textContent = 'Unsaved';
                document.getElementById('bannerStatus').style.color = 'var(--warning)';

                // Get image dimensions
                const img = new Image();
                img.onload = function() {
                    const info = `${this.width}??${this.height}px`;
                    document.getElementById('uploadInfo').textContent = info;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Switch Preview Mode
        function switchPreviewMode(mode) {
            bannerState.previewMode = mode;

            // Update button states
            document.getElementById('desktopModeBtn').classList.toggle('active', mode === 'desktop');
            document.getElementById('mobileModeBtn').classList.toggle('active', mode === 'mobile');

            // Update preview container height
            const preview = document.getElementById('bannerLivePreview');
            if (mode === 'mobile') {
                preview.classList.add('mobile-preview');
            } else {
                preview.classList.remove('mobile-preview');
            }

            // Update preview and displays
            updateBannerPreview();
            updatePositionDisplays();
        }

        // Update Banner Preview
        function updateBannerPreview() {
            const preview = document.getElementById('bannerLivePreview');
            if (!preview || !bannerState.currentImage) return;
            if (!isValidBannerUrl(bannerState.currentImage)) {
                preview.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-500 text-center">
                        <div>
                            <i class="fa-solid fa-image"></i>
                            <p class="text-[13px]">Banner image missing or invalid</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Get current position based on preview mode
            const currentPosX = bannerState.previewMode === 'mobile' ? bannerState.posX_mobile : bannerState.posX;
            const currentPosY = bannerState.previewMode === 'mobile' ? bannerState.posY_mobile : bannerState.posY;

            let imageStyle = `
                width: 100%;
                height: 100%;
                object-fit: ${bannerState.fit};
                object-position: ${currentPosX}% ${currentPosY}%;
            `;

            // If fit is 'none', apply scale transform
            if (bannerState.fit === 'none') {
                imageStyle = `
                    width: auto;
                    height: auto;
                    max-width: none;
                    max-height: none;
                    position: absolute;
                    left: ${currentPosX}%;
                    top: ${currentPosY}%;
                    transform: translate(-50%, -50%) scale(${bannerState.scale / 100});
                    transform-origin: center;
                `;
            }

            preview.innerHTML = `
                <img src="${bannerState.currentImage}" style="${imageStyle}">
                <div class="banner-position-overlay">
                    <div class="banner-position-indicator">
                        ${Math.round(currentPosX)}% ?? ${Math.round(currentPosY)}%
                        ${bannerState.fit === 'none' ? ` ??? ${bannerState.scale}%` : ''}
                    </div>
                </div>
            `;
        }

        // Set Image Fit
        function setImageFit(fit) {
            bannerState.fit = fit;

            // Update button states
            ['fit-cover', 'fit-contain', 'fit-fill', 'fit-none'].forEach(id => {
                document.getElementById(id)?.classList.remove('active');
            });
            document.getElementById('fit-' + fit)?.classList.add('active');

            // Show/hide scale controls
            const scaleControls = document.getElementById('scaleControls');
            if (scaleControls) {
                scaleControls.style.display = fit === 'none' ? 'block' : 'none';
            }

            updateBannerPreview();
        }

        // Update Image Scale
        function updateImageScale(value) {
            bannerState.scale = parseInt(value);
            document.getElementById('scaleValue').textContent = value;
            updateBannerPreview();
        }

        // Drag Handlers
        function startDrag(e) {
            if (!bannerState.currentImage) return;

            bannerState.isDragging = true;
            bannerState.dragStartX = e.clientX;
            bannerState.dragStartY = e.clientY;

            const preview = document.getElementById('bannerLivePreview');
            preview.classList.add('dragging');
        }

        function handleDrag(e) {
            if (!bannerState.isDragging) return;

            const deltaX = e.clientX - bannerState.dragStartX;
            const deltaY = e.clientY - bannerState.dragStartY;

            // Convert pixel movement to percentage
            const sensitivity = 0.5;

            // Update the appropriate position based on preview mode
            if (bannerState.previewMode === 'mobile') {
                bannerState.posX_mobile = Math.max(0, Math.min(100, bannerState.posX_mobile + (deltaX * sensitivity)));
                bannerState.posY_mobile = Math.max(0, Math.min(100, bannerState.posY_mobile + (deltaY * sensitivity)));
            } else {
                bannerState.posX = Math.max(0, Math.min(100, bannerState.posX + (deltaX * sensitivity)));
                bannerState.posY = Math.max(0, Math.min(100, bannerState.posY + (deltaY * sensitivity)));
            }

            bannerState.dragStartX = e.clientX;
            bannerState.dragStartY = e.clientY;

            updateBannerPreview();
            updatePositionDisplays();
        }

        function stopDrag() {
            if (bannerState.isDragging) {
                bannerState.isDragging = false;
                const preview = document.getElementById('bannerLivePreview');
                preview.classList.remove('dragging');
            }
        }

        // Set Banner Position (Presets)
        function setBannerPosition(position, buttonEl) {
            // Update button states
            document.querySelectorAll('.banner-quick-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (buttonEl) {
                buttonEl.classList.add('active');
            }

            let posX = 50, posY = 50;
            switch(position) {
                case 'top':
                    posX = 50;
                    posY = 0;
                    break;
                case 'center':
                    posX = 50;
                    posY = 50;
                    break;
                case 'bottom':
                    posX = 50;
                    posY = 100;
                    break;
            }

            // Update the appropriate position based on preview mode
            if (bannerState.previewMode === 'mobile') {
                bannerState.posX_mobile = posX;
                bannerState.posY_mobile = posY;
            } else {
                bannerState.posX = posX;
                bannerState.posY = posY;
            }

            updateBannerPreview();
            updatePositionDisplays();
        }

        // Adjust Banner Position (Fine Tune)
        function adjustBannerPosition(direction) {
            const step = 5;

            // Get current positions based on preview mode
            let posX = bannerState.previewMode === 'mobile' ? bannerState.posX_mobile : bannerState.posX;
            let posY = bannerState.previewMode === 'mobile' ? bannerState.posY_mobile : bannerState.posY;

            switch(direction) {
                case 'up':
                    posY = Math.max(0, posY - step);
                    break;
                case 'down':
                    posY = Math.min(100, posY + step);
                    break;
                case 'left':
                    posX = Math.max(0, posX - step);
                    break;
                case 'right':
                    posX = Math.min(100, posX + step);
                    break;
            }

            // Update the appropriate position based on preview mode
            if (bannerState.previewMode === 'mobile') {
                bannerState.posX_mobile = posX;
                bannerState.posY_mobile = posY;
            } else {
                bannerState.posX = posX;
                bannerState.posY = posY;
            }

            updateBannerPreview();
            updatePositionDisplays();
        }

        // Update Position Displays
        function updatePositionDisplays() {
            // Display current position based on preview mode
            const currentPosX = bannerState.previewMode === 'mobile' ? bannerState.posX_mobile : bannerState.posX;
            const currentPosY = bannerState.previewMode === 'mobile' ? bannerState.posY_mobile : bannerState.posY;

            document.getElementById('posXDisplay').textContent = Math.round(currentPosX) + '%';
            document.getElementById('posYDisplay').textContent = Math.round(currentPosY) + '%';
        }

        // Save Banner
        async function saveBanner() {
            if (!bannerState.currentImage) {
                alert('Please upload an image first');
                return;
            }

            // Get API reference from adminPanel
            const api = window.adminPanel?.api;
            if (!api || !api.db) {
                alert('AdminPanel API not available. Please refresh the page.');
                return;
            }

            const statusEl = document.getElementById('bannerStatus');
            statusEl.textContent = 'Saving...';
            statusEl.style.color = 'var(--warning)';

            try {
                // If editing existing banner
                if (bannerState.currentBannerId) {
                    // Prepare update data
                    const updateData = {
                        custom_position_x: Math.round(bannerState.posX),
                        custom_position_y: Math.round(bannerState.posY),
                        custom_position_x_mobile: Math.round(bannerState.posX_mobile),
                        custom_position_y_mobile: Math.round(bannerState.posY_mobile),
                        image_fit: bannerState.fit
                    };

                    // Only include image_scale if needed
                    if (bannerState.fit === 'none') {
                        updateData.image_scale = bannerState.scale;
                    }

                    // Update banner with new position
                    const { error } = await api.db
                        .from('banners')
                        .update(updateData)
                        .eq('id', bannerState.currentBannerId);

                    if (error) {
                        // If error mentions image_scale, retry without it
                        if (error.message && error.message.includes('image_scale')) {
                            console.warn('image_scale column not found, retrying without it...');
                            delete updateData.image_scale;
                            const { error: retryError } = await api.db
                                .from('banners')
                                .update(updateData)
                                .eq('id', bannerState.currentBannerId);
                            if (retryError) throw retryError;
                        } else {
                            throw error;
                        }
                    }

                    statusEl.textContent = 'Saved';
                    statusEl.style.color = 'var(--success)';

                    // Trigger banner reload on main site
                    triggerBannerReloadGlobally();

                    // Reload banners
                    loadBannerList();
                } else {
                    // New banner - upload the image first
                    const uploadInput = document.getElementById('bannerUploadInput');
                    if (uploadInput && uploadInput.files.length > 0) {
                        const file = uploadInput.files[0];

                        // Upload image to Supabase storage
                        statusEl.textContent = 'Uploading image...';
                        const imageUrl = await uploadBannerImage(file, api);

                        // Prepare banner data
                        const bannerData = {
                            image_url: imageUrl,
                            title: file.name.replace(/\.[^/.]+$/, ''),
                            image_fit: bannerState.fit,
                            custom_position_x: Math.round(bannerState.posX),
                            custom_position_y: Math.round(bannerState.posY),
                            custom_position_x_mobile: Math.round(bannerState.posX_mobile),
                            custom_position_y_mobile: Math.round(bannerState.posY_mobile),
                            link_type: 'none',
                            order_index: 0,
                            active: true
                        };

                        // Only include image_scale if needed
                        if (bannerState.fit === 'none') {
                            bannerData.image_scale = bannerState.scale;
                        }

                        // Create new banner
                        const { error } = await api.db
                            .from('banners')
                            .insert([bannerData]);

                        if (error) {
                            // If error mentions image_scale, retry without it
                            if (error.message && error.message.includes('image_scale')) {
                                console.warn('image_scale column not found, retrying without it...');
                                delete bannerData.image_scale;
                                const { error: retryError } = await api.db
                                    .from('banners')
                                    .insert([bannerData]);
                                if (retryError) throw retryError;
                            } else {
                                throw error;
                            }
                        }

                        statusEl.textContent = 'Saved';
                        statusEl.style.color = 'var(--success)';

                        // Clear upload input
                        uploadInput.value = '';

                        // Trigger banner reload on main site
                        triggerBannerReloadGlobally();

                        // Reload banners
                        loadBannerList();
                    } else {
                        alert('Please upload an image file');
                        statusEl.textContent = 'Error';
                        statusEl.style.color = 'var(--error)';
                    }
                }
            } catch (error) {
                console.error('Error saving banner:', error);
                console.log('Error message:', error.message);
                console.log('Error details:', error.details);
                console.log('Error hint:', error.hint);
                console.log('Error code:', error.code);
                console.log('Full error object:', JSON.stringify(error, null, 2));

                let errorMsg = error.message || 'Unknown error';
                if (error.details) errorMsg += '\n\nDetails: ' + error.details;
                if (error.hint) errorMsg += '\n\nHint: ' + error.hint;
                if (error.code) errorMsg += '\n\nCode: ' + error.code;

                alert('Failed to save banner:\n' + errorMsg);
                statusEl.textContent = 'Error';
                statusEl.style.color = 'var(--error)';
            }
        }

        // Clear Banner
        function clearBanner() {
            if (!confirm('Clear current banner?')) return;

            bannerState.currentImage = null;
            bannerState.posX = 50;
            bannerState.posY = 50;
            bannerState.posX_mobile = 50;
            bannerState.posY_mobile = 50;
            bannerState.fit = 'cover';
            bannerState.scale = 100;
            bannerState.currentBannerId = null;

            // Reset UI
            setImageFit('cover');

            const preview = document.getElementById('bannerLivePreview');
            preview.innerHTML = `
                <div class="flex items-center justify-center h-full text-gray-500 text-center">
                    <div>
                        <i class="fa-solid fa-image text-3xl mb-2 opacity-30"></i>
                        <p class="text-[13px]">Select or upload a banner to preview</p>
                    </div>
                </div>
            `;

            document.getElementById('uploadInfo').textContent = 'Recommended: 1920??100px';
            document.getElementById('bannerStatus').textContent = 'Ready';
            document.getElementById('bannerStatus').style.color = 'var(--success)';

            updatePositionDisplays();
        }

        async function cleanInvalidBannerUrls() {
            if (!confirm('Remove invalid banner image URLs? This will clear placeholders like ${...}.')) {
                return;
            }

            const api = window.adminPanel?.api;
            if (!api || !api.db) {
                alert('AdminPanel API not available. Please refresh the page.');
                return;
            }

            try {
                const { error } = await api.db
                    .from('banners')
                    .update({ image_url: null })
                    .or('image_url.like.%${%,image_url.ilike.%7B%,image_url.ilike.%7D%');

                if (error) throw error;

                loadBannerList();
                alert('Invalid banner URLs cleared.');
            } catch (error) {
                console.error('Error cleaning invalid banner URLs:', error);
                alert('Failed to clean invalid banner URLs.');
            }
        }

        // Load Banner List
        async function loadBannerList(retryCount = 0) {
            const container = document.getElementById('bannerListContainer');
            if (!container) return;

            container.innerHTML = `
                <div class="text-center p-10 text-gray-500">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-4"></i>
                    <p>Loading banners...</p>
                </div>
            `;

            // Wait for API to be available (max 3 retries)
            if (!window.api && !window.adminBanners && !window.adminPanel && retryCount < 3) {
                console.log('Waiting for API... retry', retryCount + 1);
                setTimeout(() => loadBannerList(retryCount + 1), 1000);
                return;
            }

            try {
                // Use adminPanel.api directly
                const api = window.adminPanel?.api;

                // Check if we have API access
                if (!api || !api.db) {
                    throw new Error('AdminPanel API not available. Try refreshing the page.');
                }

                // Always load directly from database
                console.log('Loading banners from database using adminPanel.api...');
                const { data, error } = await api.db
                    .from('banners')
                    .select('*')
                    .order('order_index', { ascending: true })
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Database error:', error);
                    throw error;
                }

                const banners = data || [];
                console.log('Query returned:', banners.length, 'banners');

                if (banners.length === 0) {
                    container.innerHTML = `
                        <div class="text-center p-10 text-gray-500">
                            <i class="fa-solid fa-image text-5xl opacity-30 mb-4"></i>
                            <p>No banners yet. Upload your first banner above!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = banners.map(banner => {
                    const safeImageUrl = isValidBannerUrl(banner.image_url) ? banner.image_url : '';
                    return `
                        <div class="banner-list-item" data-banner-id="${banner.id}" data-banner-url="${safeImageUrl}" data-pos-x="${banner.custom_position_x || 50}" data-pos-y="${banner.custom_position_y || 50}" data-fit="${banner.image_fit || 'cover'}" data-scale="${banner.image_scale || 100}" data-pos-x-mobile="${banner.custom_position_x_mobile || 50}" data-pos-y-mobile="${banner.custom_position_y_mobile || 50}">
                            <div class="banner-list-thumb">
                                ${safeImageUrl ? `<img src="${safeImageUrl}" alt="${banner.title || 'Banner'}" class="object-cover">` : '<div class="bg-gray-700 w-full h-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-image"></i></div>'}
                            </div>
                            <div class="banner-list-info">
                                <div class="banner-list-title">${banner.title || 'Untitled Banner'}</div>
                                <div class="banner-list-meta">
                                    <span style="color: ${banner.active ? 'var(--success)' : 'var(--muted)'}">${banner.active ? 'Active' : 'Inactive'}</span>
                                    ${banner.custom_position_x ? ` (${Math.round(banner.custom_position_x)}% x ${Math.round(banner.custom_position_y)}%)` : ''}
                                </div>
                            </div>
                            <button class="btn secondary btn-sm delete-banner-btn" data-banner-id="${banner.id}">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    `;
                }).join('');


