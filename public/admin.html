<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://cdn.quilljs.com https://pagead2.googlesyndication.com https://static.cloudflareinsights.com https://*.gstatic.com https://*.adtrafficquality.google; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com https://cdn.quilljs.com; img-src 'self' data: https: blob:; font-src 'self' data: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.gstatic.com; frame-src https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://*.adtrafficquality.google https://*.google.com; connect-src 'self' https://*.supabase.co https://accounts.google.com https://cdn.jsdelivr.net https://goatmouth-odds-api.onrender.com https://*.google https://*.gstatic.com;">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Panel - GoatMouth</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <script>
        window.ODDS_API_URL = 'https://goatmouth-odds-api.onrender.com';
    </script>
    <meta name="theme-color" content="#1a4d2e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous">

    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS (compiled) -->
    <link rel="stylesheet" href="css/output.css?v=4.4">
    <link rel="stylesheet" href="css/styles.css?v=4.4">
    <link rel="stylesheet" href="css/mobile.css?v=4.4">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/admin-full.css">
    <script>
        // Reserved for future configuration
    </script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2580594240598942"
         crossorigin="anonymous"></script>
</head>
<body>
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Logo Header -->
    <div class="logo-header">
        <div class="flex items-center gap-3">
            <button class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="logo-container">
                <img src="assets/official.png" alt="GoatMouth Logo">
                <span class="logo-text">GoatMouth Admin Panel</span>
            </div>
        </div>
        <div class="user-info">
            <div class="user-badge cursor-pointer" onclick="adminPanel.showAdminProfileModal()" title="View Profile">
                <i class="fa-solid fa-user mr-2"></i>
                <span id="admin-username">Admin</span>
                <span class="role-badge">Admin</span>
            </div>
            <button class="btn secondary" onclick="window.location.href='index.html'" title="Back to App">
                <i class="fa-solid fa-home"></i>
                <span class="btn-text">Home</span>
            </button>
            <button class="btn secondary" id="admin-signout" title="Sign Out">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span class="btn-text">Sign Out</span>
            </button>
        </div>
    </div>

    <!-- Single Unified Navigation Bar -->
    <div class="menubar">
        <button class="active" onclick="switchView('dashboard')">
            <i class="fa-solid fa-chart-line"></i> Dashboard
        </button>
        <button onclick="switchView('markets')">
            <i class="fa-solid fa-chart-simple"></i> Markets
        </button>
        <button onclick="switchView('banners')">
            <i class="fa-solid fa-image"></i> Banners
        </button>
        <button onclick="switchView('users')">
            <i class="fa-solid fa-users"></i> Users
        </button>
        <button onclick="switchView('activity')">
            <i class="fa-solid fa-clock-rotate-left"></i> Activity
        </button>
        <button onclick="switchView('transactions')">
            <i class="fa-solid fa-receipt"></i> Transactions
        </button>
        <button onclick="switchView('messages')">
            <i class="fa-solid fa-envelope"></i> Messages
            <span id="unread-badge" class="badge info hidden">0</span>
        </button>
        <button onclick="switchView('voting')">
            <i class="fa-solid fa-check-circle"></i> Voting
            <span id="pending-proposals-badge" class="badge warning hidden">0</span>
        </button>
        <button onclick="switchView('api')">
            <i class="fa-solid fa-signal"></i> API & Insights
        </button>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard Panel -->
            <section class="tabpanel active" id="dashboardPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-gauge-high"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Dashboard</h2>
                        <p>Overview of platform metrics and activity</p>
                    </div>
                </div>

                <!-- Stats Cards with Visual Enhancements -->
                <div class="stats-grid">
                    <div class="stat-card clickable-card" onclick="switchView('users')" title="Click to manage users">
                        <div class="stat-icon">
                            <i class="fa-solid fa-users"></i>
                        </div>
                        <h3><i class="fa-solid fa-user-plus"></i> Total Users</h3>
                        <div class="value">
                            <span id="stat-users">0</span>
                            <span class="trend up">
                                <i class="fa-solid fa-arrow-up"></i> 12%
                            </span>
                        </div>
                        <div class="label">
                            Registered users this month
                            <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>

                    <div class="stat-card clickable-card" onclick="switchView('markets')" title="Click to manage markets">
                        <div class="stat-icon" style="background: #2196f3; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <h3><i class="fa-solid fa-chart-simple"></i> Active Markets</h3>
                        <div class="value">
                            <span id="stat-markets">0</span>
                            <span class="trend up">
                                <i class="fa-solid fa-arrow-up"></i> 8%
                            </span>
                        </div>
                        <div class="label">
                            Live prediction markets
                            <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>

                    <div class="stat-card clickable-card" onclick="switchView('transactions')" title="Click to view transactions">
                        <div class="stat-icon" style="background: #ff9800; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);">
                            <i class="fa-solid fa-receipt"></i>
                        </div>
                        <h3><i class="fa-solid fa-coins"></i> Transactions</h3>
                        <div class="value">
                            <span id="stat-transactions">0</span>
                            <span class="trend up">
                                <i class="fa-solid fa-arrow-up"></i> 24%
                            </span>
                        </div>
                        <div class="label">
                            Total transactions today
                            <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>

                    <div class="stat-card clickable-card" onclick="switchView('messages')" title="Click to view messages">
                        <div class="stat-icon" style="background: #9c27b0; box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);">
                            <i class="fa-solid fa-envelope"></i>
                        </div>
                        <h3><i class="fa-solid fa-message"></i> Messages</h3>
                        <div class="value">
                            <span id="stat-messages">0</span>
                            <span class="trend down">
                                <i class="fa-solid fa-arrow-down"></i> 5%
                            </span>
                        </div>
                        <div class="label">
                            Unread messages
                            <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3><i class="fa-solid fa-chart-area"></i> Activity Overview</h3>
                        <canvas id="activityChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3><i class="fa-solid fa-chart-pie"></i> Market Distribution</h3>
                        <canvas id="marketChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <!-- Recent Activity Feed -->
                <div class="activity-feed">
                    <h3><i class="fa-solid fa-clock-rotate-left"></i> Recent Activity</h3>
                    <div id="activity-list">
                        <!-- Loading skeleton -->
                        <div class="skeleton-list">
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Markets Panel -->
            <section class="tabpanel" id="marketsPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-chart-simple"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Markets Management</h2>
                        <p>Create and manage prediction markets with live preview</p>
                    </div>
                </div>

                <!-- Market Tabs -->
                <div class="market-tabs">
                    <button class="market-tab active" data-tab="create" onclick="switchMarketTab('create')">
                        <i class="fa-solid fa-plus-circle"></i> Create Market
                    </button>
                    <button class="market-tab" data-tab="all" onclick="switchMarketTab('all')">
                        <i class="fa-solid fa-list"></i> All Markets
                    </button>
                </div>

                <!-- Create Market Tab -->
                <div id="createMarketTab" class="market-tab-content active">
                    <div class="market-creation-grid">
                        <!-- Left: Live Preview -->
                        <div class="market-preview-container">
                            <div class="market-preview-header">
                                <h3 class="market-preview-title">
                                    <i class="fa-solid fa-eye"></i> Live Preview
                                </h3>
                            </div>
                            <div class="market-preview-wrapper">
                                <div class="preview-market-card" id="marketPreviewCard">
                                    <div class="preview-market-image" id="previewImage">
                                        <i class="fa-solid fa-image"></i>
                                    </div>
                                    <div class="preview-market-content">
                                        <div class="preview-market-header">
                                            <div style="flex: 1;">
                                                <h3 class="preview-market-title" id="previewTitle">Market Title</h3>
                                                <span class="preview-market-category" id="previewCategory">SPORTS</span>
                                            </div>
                                        </div>
                                        <p class="preview-market-description" id="previewDescription">
                                            Market description will appear here...
                                        </p>
                                        <div class="preview-market-options" id="previewOptions">
                                            <div class="preview-option">
                                                <div class="preview-option-label">YES</div>
                                                <div class="preview-option-odds">50%</div>
                                            </div>
                                            <div class="preview-option">
                                                <div class="preview-option-label">NO</div>
                                                <div class="preview-option-odds">50%</div>
                                            </div>
                                        </div>
                                        <div class="preview-market-meta">
                                            <div class="preview-market-volume">
                                                Volume: <strong id="previewVolume">$0</strong>
                                            </div>
                                            <div class="preview-market-traders">
                                                <i class="fa-solid fa-users"></i>
                                                <span id="previewTraders">0 traders</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Creation Form -->
                        <div class="market-form-container">
                            <form id="createMarketForm">
                                <!-- Basic Information -->
                                <div class="market-form-section">
                                    <h4 class="market-form-section-title">
                                        <i class="fa-solid fa-info-circle"></i> Basic Information
                                    </h4>

                                    <div class="market-form-group">
                                        <label class="market-form-label required">Market Title</label>
                                        <input
                                            type="text"
                                            class="market-form-input"
                                            id="marketTitle"
                                            placeholder="e.g., Will the Lakers win the championship?"
                                            required
                                            oninput="updatePreview()"
                                        >
                                        <div class="market-form-help">Keep it clear and concise</div>
                                    </div>

                                    <div class="market-form-group">
                                        <label class="market-form-label required">Description</label>
                                        <div id="marketDescriptionEditor" style="background: var(--bg); border: 2px solid var(--border); border-radius: 8px; min-height: 150px;"></div>
                                        <div class="market-form-help">Explain the market conditions clearly - supports rich text formatting</div>
                                    </div>

                                    <div class="market-form-group">
                                        <label class="market-form-label required">Category</label>
                                        <select
                                            class="market-form-select"
                                            id="marketCategory"
                                            required
                                            onchange="updatePreview()"
                                        >
                                            <option value="">Select category...</option>
                                            <option value="Sports">Sports</option>
                                            <option value="Politics">Politics</option>
                                            <option value="Entertainment">Entertainment</option>
                                            <option value="Technology">Technology</option>
                                            <option value="Finance">Finance</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Market Image -->
                                <div class="market-form-section">
                                    <h4 class="market-form-section-title">
                                        <i class="fa-solid fa-image"></i> Market Image
                                    </h4>

                                    <div class="market-form-group">
                                        <div class="market-image-upload">
                                            <label class="market-image-upload-btn">
                                                <input
                                                    type="file"
                                                    id="marketImage"
                                                    accept="image/*"
                                                    onchange="handleImageUpload(event)"
                                                >
                                                <i class="fa-solid fa-cloud-arrow-up"></i>
                                                <span>Click to upload image</span>
                                                <small style="color: var(--muted);">PNG, JPG up to 5MB</small>
                                            </label>
                                        </div>
                                        <div class="market-form-help">Upload a relevant image for the market</div>
                                    </div>
                                </div>

                                <!-- Market Options -->
                                <div class="market-form-section">
                                    <h4 class="market-form-section-title">
                                        <i class="fa-solid fa-list-check"></i> Market Options
                                    </h4>

                                    <div class="market-options-container" id="marketOptionsContainer">
                                        <div class="market-option-group">
                                            <input
                                                type="text"
                                                class="market-form-input market-option-input"
                                                placeholder="Option 1 (e.g., YES)"
                                                required
                                                oninput="updatePreview()"
                                            >
                                        </div>
                                        <div class="market-option-group">
                                            <input
                                                type="text"
                                                class="market-form-input market-option-input"
                                                placeholder="Option 2 (e.g., NO)"
                                                required
                                                oninput="updatePreview()"
                                            >
                                        </div>
                                    </div>

                                    <button
                                        type="button"
                                        class="market-add-option"
                                        onclick="addMarketOption()"
                                    >
                                        <i class="fa-solid fa-plus"></i> Add Another Option
                                    </button>
                                    <div class="market-form-help">Minimum 2 options required</div>
                                </div>

                                <!-- Market Settings -->
                                <div class="market-form-section">
                                    <h4 class="market-form-section-title">
                                        <i class="fa-solid fa-gear"></i> Market Settings
                                    </h4>

                                    <div class="market-form-group">
                                        <label class="market-form-label required">Resolution Date</label>
                                        <input
                                            type="datetime-local"
                                            class="market-form-input"
                                            id="marketResolutionDate"
                                            required
                                        >
                                        <div class="market-form-help">When will this market resolve?</div>
                                    </div>

                                    <div class="market-form-group">
                                        <label class="market-form-label">Initial Liquidity (Optional)</label>
                                        <input
                                            type="number"
                                            class="market-form-input"
                                            id="marketLiquidity"
                                            placeholder="0"
                                            min="0"
                                            step="0.01"
                                        >
                                        <div class="market-form-help">Starting liquidity for the market</div>
                                    </div>

                                    <div class="market-form-group">
                                        <label class="market-form-label">Market Fee (%)</label>
                                        <input
                                            type="number"
                                            class="market-form-input"
                                            id="marketFee"
                                            placeholder="2"
                                            min="0"
                                            max="10"
                                            step="0.1"
                                            value="2"
                                        >
                                        <div class="market-form-help">Trading fee percentage (0-10%)</div>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="market-form-actions">
                                    <button type="button" class="market-cancel-btn" onclick="resetMarketForm()">
                                        <i class="fa-solid fa-times"></i> Reset
                                    </button>
                                    <button type="submit" class="market-submit-btn">
                                        <i class="fa-solid fa-rocket"></i> Create Market
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- All Markets Tab -->
                <div id="allMarketsTab" class="market-tab-content">
                    <div id="admin-content-markets">
                        <div class="skeleton-list">
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Banners Panel -->
            <section class="tabpanel" id="bannersPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-image"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Banner Management</h2>
                        <p>1:1 preview and position control</p>
                    </div>
                </div>

                <!-- Main Banner Editor -->
                <div class="banner-editor-grid">
                    <!-- Left: Live Preview -->
                    <div class="banner-preview-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="color: var(--accent); font-size: 16px; font-weight: 600; margin: 0;">
                                <i class="fa-solid fa-eye"></i> Live Site Preview
                            </h3>
                            <!-- Preview Mode Toggle -->
                            <div style="display: flex; gap: 8px; background: var(--bg2); border-radius: 8px; padding: 4px;">
                                <button id="desktopModeBtn" class="banner-quick-btn active" onclick="switchPreviewMode('desktop')" style="padding: 8px 16px;">
                                    <i class="fa-solid fa-desktop"></i> Desktop
                                </button>
                                <button id="mobileModeBtn" class="banner-quick-btn" onclick="switchPreviewMode('mobile')" style="padding: 8px 16px;">
                                    <i class="fa-solid fa-mobile-screen-button"></i> Mobile
                                </button>
                            </div>
                        </div>
                        <div class="banner-preview-wrapper">
                            <!-- Mock Header -->
                            <div class="banner-mock-header">
                                <div class="banner-mock-logo"></div>
                                <div style="flex: 1; font-weight: 700; color: #FFD700; font-size: 18px;">GoatMouth</div>
                            </div>

                            <!-- Mock Navigation -->
                            <div class="banner-mock-nav">
                                <div class="banner-mock-nav-item">Markets</div>
                                <div class="banner-mock-nav-item">Activity</div>
                                <div class="banner-mock-nav-item">Leaderboard</div>
                            </div>

                            <!-- BANNER CONTAINER (1:1 exact size) -->
                            <div id="bannerLivePreview" class="banner-live-container">
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--muted); text-align: center;">
                                    <div>
                                        <i class="fa-solid fa-image" style="font-size: 32px; margin-bottom: 8px; opacity: 0.3;"></i>
                                        <p style="font-size: 13px;">Select or upload a banner to preview</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Mock Market Cards -->
                            <div class="banner-mock-market-grid">
                                <div class="banner-mock-market-card"></div>
                                <div class="banner-mock-market-card"></div>
                                <div class="banner-mock-market-card"></div>
                            </div>
                        </div>

                        <!-- Position Info -->
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div style="flex: 1; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                                <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">HORIZONTAL</div>
                                <div id="posXDisplay" style="font-size: 18px; font-weight: 700; color: var(--accent);">50%</div>
                            </div>
                            <div style="flex: 1; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                                <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">VERTICAL</div>
                                <div id="posYDisplay" style="font-size: 18px; font-weight: 700; color: var(--accent);">50%</div>
                            </div>
                            <div style="flex: 1; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                                <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">STATUS</div>
                                <div id="bannerStatus" style="font-size: 18px; font-weight: 700; color: var(--success);">Ready</div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Control Panel -->
                    <div class="banner-control-panel">
                        <h3 style="font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 20px;">
                            <i class="fa-solid fa-sliders"></i> Quick Controls
                        </h3>

                        <!-- Upload Section -->
                        <div class="banner-control-section">
                            <label class="banner-control-label">Upload Banner</label>
                            <input type="file" id="bannerUploadInput" accept="image/*" style="display: none;">
                            <button class="btn" style="width: 100%; justify-content: center;" onclick="document.getElementById('bannerUploadInput').click()">
                                <i class="fa-solid fa-cloud-arrow-up"></i> Choose Image
                            </button>
                            <div id="uploadInfo" style="margin-top: 8px; font-size: 11px; color: var(--muted); text-align: center;">
                                Recommended: 1920Ã—100px
                            </div>
                        </div>

                        <!-- Position Presets -->
                        <div class="banner-control-section">
                            <label class="banner-control-label">Position Presets</label>
                            <div class="banner-quick-actions">
                                <button class="banner-quick-btn" onclick="setBannerPosition('top')">
                                    <i class="fa-solid fa-arrow-up"></i> Top
                                </button>
                                <button class="banner-quick-btn active" onclick="setBannerPosition('center')">
                                    <i class="fa-solid fa-circle-dot"></i> Center
                                </button>
                                <button class="banner-quick-btn" onclick="setBannerPosition('bottom')">
                                    <i class="fa-solid fa-arrow-down"></i> Bottom
                                </button>
                            </div>
                        </div>

                        <!-- Fine Tune -->
                        <div class="banner-control-section">
                            <label class="banner-control-label">Fine Tune</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                <button class="banner-quick-btn" style="grid-column: 2;" onclick="adjustBannerPosition('up')">
                                    <i class="fa-solid fa-chevron-up"></i>
                                </button>
                                <button class="banner-quick-btn" onclick="adjustBannerPosition('left')">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </button>
                                <button class="banner-quick-btn" onclick="setBannerPosition('center')" title="Reset">
                                    <i class="fa-solid fa-rotate-right"></i>
                                </button>
                                <button class="banner-quick-btn" onclick="adjustBannerPosition('right')">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </button>
                                <button class="banner-quick-btn" style="grid-column: 2;" onclick="adjustBannerPosition('down')">
                                    <i class="fa-solid fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Image Fit -->
                        <div class="banner-control-section">
                            <label class="banner-control-label">How Image Fills Container</label>
                            <div style="display: grid; gap: 8px;">
                                <button class="banner-quick-btn active" id="fit-cover" onclick="setImageFit('cover')" style="text-align: left; padding: 12px;">
                                    <div style="font-weight: 700; margin-bottom: 2px;">Cover (Recommended)</div>
                                    <div style="font-size: 10px; opacity: 0.7;">Fills container, crops if needed</div>
                                </button>
                                <button class="banner-quick-btn" id="fit-contain" onclick="setImageFit('contain')" style="text-align: left; padding: 12px;">
                                    <div style="font-weight: 700; margin-bottom: 2px;">Contain</div>
                                    <div style="font-size: 10px; opacity: 0.7;">Shows full image, may have empty space</div>
                                </button>
                                <button class="banner-quick-btn" id="fit-fill" onclick="setImageFit('fill')" style="text-align: left; padding: 12px;">
                                    <div style="font-weight: 700; margin-bottom: 2px;">Stretch to Fill</div>
                                    <div style="font-size: 10px; opacity: 0.7;">Stretches to fit exactly</div>
                                </button>
                                <button class="banner-quick-btn" id="fit-none" onclick="setImageFit('none')" style="text-align: left; padding: 12px;">
                                    <div style="font-weight: 700; margin-bottom: 2px;">Original Size</div>
                                    <div style="font-size: 10px; opacity: 0.7;">No scaling, use position controls</div>
                                </button>
                            </div>
                        </div>

                        <!-- Image Scale (for 'none' fit type) -->
                        <div class="banner-control-section" id="scaleControls" style="display: none;">
                            <label class="banner-control-label">Image Scale</label>
                            <input type="range" id="imageScale" min="50" max="200" value="100" step="10"
                                   style="width: 100%; margin-bottom: 8px;"
                                   oninput="updateImageScale(this.value)">
                            <div style="text-align: center; font-size: 12px; color: var(--muted);">
                                Scale: <span id="scaleValue">100</span>%
                            </div>
                        </div>

                        <!-- Save Actions -->
                        <div class="banner-control-section">
                            <button class="btn" style="width: 100%; justify-content: center; background: var(--success);" onclick="saveBanner()">
                                <i class="fa-solid fa-floppy-disk"></i> Save Banner
                            </button>
                            <button class="btn secondary" style="width: 100%; justify-content: center; margin-top: 8px;" onclick="clearBanner()">
                                <i class="fa-solid fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Debug Info -->
                <div style="background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <h4 style="font-size: 13px; font-weight: 600; color: var(--muted); text-transform: uppercase;">
                            <i class="fa-solid fa-bug"></i> System Status
                        </h4>
                        <button class="btn secondary btn-sm" onclick="checkSystemStatus()">
                            <i class="fa-solid fa-rotate"></i> Check
                        </button>
                    </div>
                    <div id="systemStatus" style="font-family: monospace; font-size: 11px; color: var(--muted);">
                        Click "Check" to view system status
                    </div>
                </div>

                <!-- Banner List -->
                <div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #fff;">
                            <i class="fa-solid fa-list"></i> Your Banners
                        </h3>
                        <button class="btn secondary" onclick="loadBannerList()">
                            <i class="fa-solid fa-rotate"></i> Refresh
                        </button>
                    </div>
                    <div id="bannerListContainer">
                        <div class="skeleton-list">
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Voting Hero Panel -->
            <section class="tabpanel" id="votingHeroPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-vote-yea"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Voting Hero Background</h2>
                        <p>Upload background image for voting page hero section</p>
                    </div>
                </div>

                <div style="max-width: 800px; margin-top: 24px;">
                    <!-- Current Image Preview -->
                    <div style="background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="color: var(--accent); margin-bottom: 16px; font-size: 16px; font-weight: 600;">
                            <i class="fa-solid fa-image"></i> Current Background
                        </h3>
                        <div id="votingHeroPreview" style="width: 100%; height: 200px; background: linear-gradient(135deg, #1f2937 0%, #111827 100%); border-radius: 8px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: var(--muted);">
                            <div style="text-align: center;">
                                <i class="fa-solid fa-image" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                                <p>No background image set</p>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Section -->
                    <div style="background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; padding: 24px;">
                        <h3 style="color: var(--accent); margin-bottom: 16px; font-size: 16px; font-weight: 600;">
                            <i class="fa-solid fa-cloud-arrow-up"></i> Upload New Background
                        </h3>
                        <input type="file" id="votingHeroUpload" accept="image/*" style="display: none;">
                        <button class="btn" style="width: 100%; justify-content: center; margin-bottom: 16px;" onclick="document.getElementById('votingHeroUpload').click()">
                            <i class="fa-solid fa-cloud-arrow-up"></i> Choose Image
                        </button>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn secondary" style="flex: 1; justify-content: center;" onclick="saveVotingHeroImage()">
                                <i class="fa-solid fa-save"></i> Save
                            </button>
                            <button class="btn secondary" style="flex: 1; justify-content: center;" onclick="removeVotingHeroImage()">
                                <i class="fa-solid fa-trash"></i> Remove
                            </button>
                        </div>
                        <div id="votingHeroStatus" style="margin-top: 16px; font-size: 14px;"></div>
                    </div>
                </div>
            </section>

            <!-- Users Panel -->
            <section class="tabpanel" id="usersPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-users"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Users</h2>
                        <p>Manage user accounts</p>
                    </div>
                </div>
                <div id="admin-content-users">
                    <div class="skeleton-list">
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- Activity Panel -->
            <section class="tabpanel" id="activityPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Site Activity</h2>
                        <p>View all recent site activity</p>
                    </div>
                </div>
                <div id="admin-content-activity">
                    <div class="skeleton-list">
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- Transactions Panel -->
            <section class="tabpanel" id="transactionsPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-receipt"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Transactions</h2>
                        <p>View transaction history</p>
                    </div>
                </div>
                <div id="admin-content-transactions">
                    <div class="skeleton-list">
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- Messages Panel -->
            <section class="tabpanel" id="messagesPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-envelope"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Messages</h2>
                        <p>Contact form submissions</p>
                    </div>
                </div>
                <div id="admin-content-messages">
                    <div class="skeleton-list">
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- Voting Panel -->
            <section class="tabpanel" id="votingPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-check-circle"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>Voting</h2>
                        <p>Manage community proposals</p>
                    </div>
                </div>
                <div id="admin-content-voting">
                    <div class="skeleton-list">
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- API & Insights Panel -->
            <section class="tabpanel" id="apiPanel">
                <div class="section-banner">
                    <div class="section-banner-icon">
                        <i class="fa-solid fa-signal"></i>
                    </div>
                    <div class="section-banner-content">
                        <h2>API & Insights</h2>
                        <p>ML Controls, Odds API health, Market analytics, and guidance insights</p>
                    </div>
                </div>

                <div id="admin-content-api" style="padding: 4px;">
                    <!-- API Health Status -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <i class="fa-solid fa-heart-pulse" style="color: var(--accent);"></i>
                            API Health Status
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="stat-card">
                                <div class="stat-value" id="api-status">
                                    <i class="fa-solid fa-circle-notch fa-spin"></i>
                                </div>
                                <div class="stat-label">Status</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="api-uptime">--</div>
                                <div class="stat-label">Uptime</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="api-response-time">--</div>
                                <div class="stat-label">Avg Response Time</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="api-requests">--</div>
                                <div class="stat-label">Total Requests (24h)</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn secondary" id="run-health-check">
                                <i class="fa-solid fa-heart-pulse"></i> Run Health Check
                            </button>
                            <button class="btn secondary" id="refresh-api-stats">
                                <i class="fa-solid fa-rotate"></i> Refresh Stats
                            </button>
                        </div>
                    </div>

                    <!-- ML Controls Section -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <i class="fa-solid fa-brain" style="color: #9c27b0;"></i>
                            Machine Learning Controls
                        </h3>

                        <div style="display: grid; gap: 20px;">
                            <!-- Model Configuration -->
                            <div>
                                <h4 style="margin-bottom: 10px; color: var(--fg); font-size: 14px;">
                                    <i class="fa-solid fa-sliders"></i> Model Configuration
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                    <div>
                                        <label class="form-label">House Margin (%)</label>
                                        <input type="number" id="ml-house-margin" class="form-input" min="0" max="10" step="0.1" value="2.0">
                                        <small style="color: var(--muted); font-size: 11px;">Platform fee percentage</small>
                                    </div>
                                    <div>
                                        <label class="form-label">Default Pool Size</label>
                                        <input type="number" id="ml-pool-size" class="form-input" min="100" max="10000" step="100" value="1000">
                                        <small style="color: var(--muted); font-size: 11px;">Liquidity pool initialization</small>
                                    </div>
                                    <div>
                                        <label class="form-label">Volatility Factor</label>
                                        <input type="number" id="ml-volatility" class="form-input" min="0" max="2" step="0.05" value="1.0">
                                        <small style="color: var(--muted); font-size: 11px;">Price sensitivity multiplier</small>
                                    </div>
                                    <div>
                                        <label class="form-label">Min Liquidity Threshold</label>
                                        <input type="number" id="ml-min-liquidity" class="form-input" min="10" max="500" step="10" value="100">
                                        <small style="color: var(--muted); font-size: 11px;">Minimum pool balance</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Feature Weights -->
                            <div>
                                <h4 style="margin-bottom: 10px; color: var(--fg); font-size: 14px;">
                                    <i class="fa-solid fa-weight-scale"></i> Feature Weights
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                    <div>
                                        <label class="form-label">Volume Weight</label>
                                        <input type="range" id="ml-volume-weight" min="0" max="100" value="40"
                                               style="width: 100%;" oninput="document.getElementById('volume-weight-val').textContent = this.value + '%'">
                                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                                            <span>0%</span>
                                            <span id="volume-weight-val">40%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label">Momentum Weight</label>
                                        <input type="range" id="ml-momentum-weight" min="0" max="100" value="30"
                                               style="width: 100%;" oninput="document.getElementById('momentum-weight-val').textContent = this.value + '%'">
                                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                                            <span>0%</span>
                                            <span id="momentum-weight-val">30%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label">Sentiment Weight</label>
                                        <input type="range" id="ml-sentiment-weight" min="0" max="100" value="20"
                                               style="width: 100%;" oninput="document.getElementById('sentiment-weight-val').textContent = this.value + '%'">
                                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                                            <span>0%</span>
                                            <span id="sentiment-weight-val">20%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label">Time Decay Weight</label>
                                        <input type="range" id="ml-time-weight" min="0" max="100" value="10"
                                               style="width: 100%;" oninput="document.getElementById('time-weight-val').textContent = this.value + '%'">
                                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                                            <span>0%</span>
                                            <span id="time-weight-val">10%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Model Actions -->
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn primary" id="save-ml-config">
                                    <i class="fa-solid fa-save"></i> Save Configuration
                                </button>
                                <button class="btn secondary" id="reset-ml-config">
                                    <i class="fa-solid fa-rotate-left"></i> Reset to Defaults
                                </button>
                                <button class="btn secondary" id="test-ml-model">
                                    <i class="fa-solid fa-flask"></i> Test Model
                                </button>
                                <button class="btn" id="export-ml-config" style="background: #607d8b; color: white;">
                                    <i class="fa-solid fa-download"></i> Export Config
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Market Analytics -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <i class="fa-solid fa-chart-line" style="color: #2196f3;"></i>
                            Market Analytics & Insights
                        </h3>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <div class="stat-value" id="total-markets-stat">--</div>
                                <div class="stat-label">Total Markets</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="stat-value" id="active-markets-stat">--</div>
                                <div class="stat-label">Active Markets</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                <div class="stat-value" id="total-volume-stat">--</div>
                                <div class="stat-label">Total Volume (24h)</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                <div class="stat-value" id="total-bets-stat">--</div>
                                <div class="stat-label">Total Bets (24h)</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                <div class="stat-value" id="avg-odds-stat">--</div>
                                <div class="stat-label">Avg Odds</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                                <div class="stat-value" id="liquidity-stat">--</div>
                                <div class="stat-label">Total Liquidity</div>
                            </div>
                        </div>

                        <!-- Top Markets Table -->
                        <div>
                            <h4 style="margin-bottom: 10px; color: var(--fg); font-size: 14px;">
                                <i class="fa-solid fa-fire"></i> Top Performing Markets
                            </h4>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--border);">
                                            <th style="padding: 10px; text-align: left; font-size: 12px; color: var(--muted);">Market</th>
                                            <th style="padding: 10px; text-align: left; font-size: 12px; color: var(--muted);">Volume</th>
                                            <th style="padding: 10px; text-align: left; font-size: 12px; color: var(--muted);">Bets</th>
                                            <th style="padding: 10px; text-align: left; font-size: 12px; color: var(--muted);">YES Price</th>
                                            <th style="padding: 10px; text-align: left; font-size: 12px; color: var(--muted);">Liquidity</th>
                                            <th style="padding: 10px; text-align: left; font-size: 12px; color: var(--muted);">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="top-markets-table">
                                        <tr>
                                            <td colspan="6" style="padding: 20px; text-align: center; color: var(--muted);">
                                                <i class="fa-solid fa-spinner fa-spin"></i> Loading market data...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div style="margin-top: 15px;">
                            <button class="btn secondary" id="refresh-market-analytics">
                                <i class="fa-solid fa-rotate"></i> Refresh Analytics
                            </button>
                            <button class="btn secondary" id="export-market-data" style="margin-left: 10px;">
                                <i class="fa-solid fa-file-export"></i> Export Data
                            </button>
                        </div>
                    </div>

                    <!-- Telemetry & Logs -->
                    <div class="card">
                        <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <i class="fa-solid fa-terminal" style="color: #ff9800;"></i>
                            API Telemetry & Logs
                        </h3>
                        <div id="telemetry-logs" style="background: #000; color: #0f0; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 300px; overflow-y: auto;">
                            <div style="color: #888;">Waiting for telemetry data...</div>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button class="btn secondary" id="clear-logs">
                                <i class="fa-solid fa-trash"></i> Clear Logs
                            </button>
                            <button class="btn secondary" id="download-logs">
                                <i class="fa-solid fa-download"></i> Download Logs
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Status Bar -->
    <div class="statusbar">
        <div>
            <i class="fa-solid fa-circle" style="color: var(--success); font-size: 8px;"></i>
            <span>GoatMouth Admin Panel</span>
        </div>
        <div id="status-info">Ready</div>
    </div>

    <!-- Modal Container -->
    <div id="modal-root"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/sanitize-helper.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/api.js"></script>
    <script src="js/shared-components.js"></script>
    <script src="js/auth-guard.js"></script>
    <script src="js/admin-banners.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/admin-ml-insights.js"></script>

    <script>
        // Mobile menu toggle
        const hamburger = document.getElementById('hamburger');
        const menubar = document.querySelector('.menubar');
        const mobileOverlay = document.getElementById('mobileOverlay');

        function toggleMobileMenu() {
            if (hamburger) hamburger.classList.toggle('active');
            if (menubar) menubar.classList.toggle('active');
            if (mobileOverlay) mobileOverlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            if (hamburger) hamburger.classList.remove('active');
            if (menubar) menubar.classList.remove('active');
            if (mobileOverlay) mobileOverlay.classList.remove('active');
        }

        if (hamburger) hamburger.addEventListener('click', toggleMobileMenu);
        if (mobileOverlay) mobileOverlay.addEventListener('click', closeMobileMenu);

        // Close dropdown menus when clicking outside
        document.addEventListener('click', function(event) {
            // Close user dropdowns
            const userDropdowns = document.querySelectorAll('.user-dropdown-menu.show-dropdown');
            userDropdowns.forEach(dropdown => {
                const button = dropdown.previousElementSibling;
                if (!dropdown.contains(event.target) && !button.contains(event.target)) {
                    dropdown.classList.remove('show-dropdown');
                }
            });

            // Close message dropdowns
            const messageDropdowns = document.querySelectorAll('.message-dropdown-menu.show-dropdown');
            messageDropdowns.forEach(dropdown => {
                const button = dropdown.previousElementSibling;
                if (!dropdown.contains(event.target) && !button.contains(event.target)) {
                    dropdown.classList.remove('show-dropdown');
                }
            });
        });

        // View switching functionality
        function switchView(view) {
            // Close mobile menu
            closeMobileMenu();

            // Remove active class from all buttons
            document.querySelectorAll('.menubar button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Add active class to clicked button
            if (event && event.target) {
                const button = event.target.closest('button');
                if (button) {
                    button.classList.add('active');
                }
            }

            // Hide all panels
            document.querySelectorAll('.tabpanel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Show selected panel
            const panelMap = {
                'dashboard': 'dashboardPanel',
                'markets': 'marketsPanel',
                'banners': 'bannersPanel',
                'voting-hero': 'votingHeroPanel',
                'users': 'usersPanel',
                  'activity': 'activityPanel',
                  'transactions': 'transactionsPanel',
                  'messages': 'messagesPanel',
                  'voting': 'votingPanel',
                  'api': 'apiPanel'
              };

            const panelId = panelMap[view];
            if (panelId) {
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.classList.add('active');
                }
            }

            // Update status bar
            const statusInfo = document.getElementById('status-info');
            if (statusInfo) {
                statusInfo.textContent = `Viewing: ${view.charAt(0).toUpperCase() + view.slice(1)}`;
            }

            // Trigger actual data loading via adminPanel
            if (window.adminPanel) {
                window.adminPanel.switchView(view);
            }

            // Special handling for banners view
            if (view === 'banners') {
                console.log('Switching to banners view, will load banners in 500ms...');
                // Wait a bit for the view to render, then load banners
                setTimeout(() => {
                    console.log('Attempting to load banner list...');
                    loadBannerList().then(() => {
                        // Auto-load last selected banner if exists
                        const lastBannerId = localStorage.getItem('lastSelectedBannerId');
                        if (lastBannerId) {
                            console.log('Auto-loading last selected banner:', lastBannerId);
                            const bannerItems = document.querySelectorAll('.banner-list-item');
                            bannerItems.forEach(item => {
                                if (item.onclick.toString().includes(lastBannerId)) {
                                    item.click();
                                }
                            });
                        }
                    });
                }, 500);
            }
        }

        // Initialize Dashboard Charts
        function initDashboardCharts() {
            // Activity Overview Chart (Line Chart)
            const activityCtx = document.getElementById('activityChart');
            if (activityCtx) {
                new Chart(activityCtx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Users',
                            data: [45, 52, 48, 65, 72, 68, 85],
                            borderColor: '#1a4d2e',
                            backgroundColor: 'rgba(26, 77, 46, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Transactions',
                            data: [120, 135, 142, 158, 165, 178, 195],
                            borderColor: '#ff9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Markets',
                            data: [8, 10, 12, 11, 15, 14, 18],
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#D4D4D4',
                                    font: {
                                        size: 12,
                                        family: 'Inter'
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#666'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#666'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                }
                            }
                        }
                    }
                });
            }

            // Market Distribution Chart (Doughnut Chart)
            const marketCtx = document.getElementById('marketChart');
            if (marketCtx) {
                new Chart(marketCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Active', 'Pending', 'Closed', 'Resolved'],
                        datasets: [{
                            data: [45, 12, 28, 15],
                            backgroundColor: [
                                '#1a4d2e',
                                '#ff9800',
                                '#e53935',
                                '#2196f3'
                            ],
                            borderColor: '#1E1E1E',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#D4D4D4',
                                    font: {
                                        size: 12,
                                        family: 'Inter'
                                    },
                                    padding: 15
                                }
                            }
                        }
                    }
                });
            }
        }

        // Initialize charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initDashboardCharts();
            initBannerEditor();
            // Activity feed is now loaded by admin.js renderDashboard()
        });

        // Banner Editor State
        let bannerState = {
            currentImage: null,
            posX: 50,
            posY: 50,
            posX_mobile: 50,
            posY_mobile: 50,
            fit: 'cover',
            scale: 100,
            isDragging: false,
            dragStartX: 0,
            dragStartY: 0,
            currentBannerId: null,
            previewMode: 'desktop' // 'desktop' or 'mobile'
        };

        // Initialize Banner Editor
        function initBannerEditor() {
            const uploadInput = document.getElementById('bannerUploadInput');
            const preview = document.getElementById('bannerLivePreview');

            // Handle image upload
            if (uploadInput) {
                uploadInput.addEventListener('change', handleBannerUpload);
            }

            // Handle drag-and-drop on preview
            if (preview) {
                preview.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', handleDrag);
                document.addEventListener('mouseup', stopDrag);
            }

            // Don't auto-load on init - wait for user to switch to banners view
            // This will be handled by switchView function
        }

        // Handle Banner Upload
        function handleBannerUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                return;
            }

            // Read and display image
            const reader = new FileReader();
            reader.onload = function(e) {
                bannerState.currentImage = e.target.result;
                bannerState.currentBannerId = null; // New upload
                updateBannerPreview();

                // Update status
                document.getElementById('bannerStatus').textContent = 'Unsaved';
                document.getElementById('bannerStatus').style.color = 'var(--warning)';

                // Get image dimensions
                const img = new Image();
                img.onload = function() {
                    const info = `${this.width}Ã—${this.height}px`;
                    document.getElementById('uploadInfo').textContent = info;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Switch Preview Mode
        function switchPreviewMode(mode) {
            bannerState.previewMode = mode;

            // Update button states
            document.getElementById('desktopModeBtn').classList.toggle('active', mode === 'desktop');
            document.getElementById('mobileModeBtn').classList.toggle('active', mode === 'mobile');

            // Update preview container height
            const preview = document.getElementById('bannerLivePreview');
            if (mode === 'mobile') {
                preview.classList.add('mobile-preview');
            } else {
                preview.classList.remove('mobile-preview');
            }

            // Update preview and displays
            updateBannerPreview();
            updatePositionDisplays();
        }

        // Update Banner Preview
        function updateBannerPreview() {
            const preview = document.getElementById('bannerLivePreview');
            if (!preview || !bannerState.currentImage) return;

            // Get current position based on preview mode
            const currentPosX = bannerState.previewMode === 'mobile' ? bannerState.posX_mobile : bannerState.posX;
            const currentPosY = bannerState.previewMode === 'mobile' ? bannerState.posY_mobile : bannerState.posY;

            let imageStyle = `
                width: 100%;
                height: 100%;
                object-fit: ${bannerState.fit};
                object-position: ${currentPosX}% ${currentPosY}%;
            `;

            // If fit is 'none', apply scale transform
            if (bannerState.fit === 'none') {
                imageStyle = `
                    width: auto;
                    height: auto;
                    max-width: none;
                    max-height: none;
                    position: absolute;
                    left: ${currentPosX}%;
                    top: ${currentPosY}%;
                    transform: translate(-50%, -50%) scale(${bannerState.scale / 100});
                    transform-origin: center;
                `;
            }

            preview.innerHTML = `
                <img src="${bannerState.currentImage}" style="${imageStyle}">
                <div class="banner-position-overlay">
                    <div class="banner-position-indicator">
                        ${Math.round(currentPosX)}% Ã— ${Math.round(currentPosY)}%
                        ${bannerState.fit === 'none' ? ` â€¢ ${bannerState.scale}%` : ''}
                    </div>
                </div>
            `;
        }

        // Set Image Fit
        function setImageFit(fit) {
            bannerState.fit = fit;

            // Update button states
            ['fit-cover', 'fit-contain', 'fit-fill', 'fit-none'].forEach(id => {
                document.getElementById(id)?.classList.remove('active');
            });
            document.getElementById('fit-' + fit)?.classList.add('active');

            // Show/hide scale controls
            const scaleControls = document.getElementById('scaleControls');
            if (scaleControls) {
                scaleControls.style.display = fit === 'none' ? 'block' : 'none';
            }

            updateBannerPreview();
        }

        // Update Image Scale
        function updateImageScale(value) {
            bannerState.scale = parseInt(value);
            document.getElementById('scaleValue').textContent = value;
            updateBannerPreview();
        }

        // Drag Handlers
        function startDrag(e) {
            if (!bannerState.currentImage) return;

            bannerState.isDragging = true;
            bannerState.dragStartX = e.clientX;
            bannerState.dragStartY = e.clientY;

            const preview = document.getElementById('bannerLivePreview');
            preview.classList.add('dragging');
        }

        function handleDrag(e) {
            if (!bannerState.isDragging) return;

            const deltaX = e.clientX - bannerState.dragStartX;
            const deltaY = e.clientY - bannerState.dragStartY;

            // Convert pixel movement to percentage
            const sensitivity = 0.5;

            // Update the appropriate position based on preview mode
            if (bannerState.previewMode === 'mobile') {
                bannerState.posX_mobile = Math.max(0, Math.min(100, bannerState.posX_mobile + (deltaX * sensitivity)));
                bannerState.posY_mobile = Math.max(0, Math.min(100, bannerState.posY_mobile + (deltaY * sensitivity)));
            } else {
                bannerState.posX = Math.max(0, Math.min(100, bannerState.posX + (deltaX * sensitivity)));
                bannerState.posY = Math.max(0, Math.min(100, bannerState.posY + (deltaY * sensitivity)));
            }

            bannerState.dragStartX = e.clientX;
            bannerState.dragStartY = e.clientY;

            updateBannerPreview();
            updatePositionDisplays();
        }

        function stopDrag() {
            if (bannerState.isDragging) {
                bannerState.isDragging = false;
                const preview = document.getElementById('bannerLivePreview');
                preview.classList.remove('dragging');
            }
        }

        // Set Banner Position (Presets)
        function setBannerPosition(position) {
            // Update button states
            document.querySelectorAll('.banner-quick-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('button').classList.add('active');

            let posX = 50, posY = 50;
            switch(position) {
                case 'top':
                    posX = 50;
                    posY = 0;
                    break;
                case 'center':
                    posX = 50;
                    posY = 50;
                    break;
                case 'bottom':
                    posX = 50;
                    posY = 100;
                    break;
            }

            // Update the appropriate position based on preview mode
            if (bannerState.previewMode === 'mobile') {
                bannerState.posX_mobile = posX;
                bannerState.posY_mobile = posY;
            } else {
                bannerState.posX = posX;
                bannerState.posY = posY;
            }

            updateBannerPreview();
            updatePositionDisplays();
        }

        // Adjust Banner Position (Fine Tune)
        function adjustBannerPosition(direction) {
            const step = 5;

            // Get current positions based on preview mode
            let posX = bannerState.previewMode === 'mobile' ? bannerState.posX_mobile : bannerState.posX;
            let posY = bannerState.previewMode === 'mobile' ? bannerState.posY_mobile : bannerState.posY;

            switch(direction) {
                case 'up':
                    posY = Math.max(0, posY - step);
                    break;
                case 'down':
                    posY = Math.min(100, posY + step);
                    break;
                case 'left':
                    posX = Math.max(0, posX - step);
                    break;
                case 'right':
                    posX = Math.min(100, posX + step);
                    break;
            }

            // Update the appropriate position based on preview mode
            if (bannerState.previewMode === 'mobile') {
                bannerState.posX_mobile = posX;
                bannerState.posY_mobile = posY;
            } else {
                bannerState.posX = posX;
                bannerState.posY = posY;
            }

            updateBannerPreview();
            updatePositionDisplays();
        }

        // Update Position Displays
        function updatePositionDisplays() {
            // Display current position based on preview mode
            const currentPosX = bannerState.previewMode === 'mobile' ? bannerState.posX_mobile : bannerState.posX;
            const currentPosY = bannerState.previewMode === 'mobile' ? bannerState.posY_mobile : bannerState.posY;

            document.getElementById('posXDisplay').textContent = Math.round(currentPosX) + '%';
            document.getElementById('posYDisplay').textContent = Math.round(currentPosY) + '%';
        }

        // Save Banner
        async function saveBanner() {
            if (!bannerState.currentImage) {
                alert('Please upload an image first');
                return;
            }

            // Get API reference from adminPanel
            const api = window.adminPanel?.api;
            if (!api || !api.db) {
                alert('AdminPanel API not available. Please refresh the page.');
                return;
            }

            const statusEl = document.getElementById('bannerStatus');
            statusEl.textContent = 'Saving...';
            statusEl.style.color = 'var(--warning)';

            try {
                // If editing existing banner
                if (bannerState.currentBannerId) {
                    // Prepare update data
                    const updateData = {
                        custom_position_x: Math.round(bannerState.posX),
                        custom_position_y: Math.round(bannerState.posY),
                        custom_position_x_mobile: Math.round(bannerState.posX_mobile),
                        custom_position_y_mobile: Math.round(bannerState.posY_mobile),
                        image_fit: bannerState.fit
                    };

                    // Only include image_scale if needed
                    if (bannerState.fit === 'none') {
                        updateData.image_scale = bannerState.scale;
                    }

                    // Update banner with new position
                    const { error } = await api.db
                        .from('banners')
                        .update(updateData)
                        .eq('id', bannerState.currentBannerId);

                    if (error) {
                        // If error mentions image_scale, retry without it
                        if (error.message && error.message.includes('image_scale')) {
                            console.warn('image_scale column not found, retrying without it...');
                            delete updateData.image_scale;
                            const { error: retryError } = await api.db
                                .from('banners')
                                .update(updateData)
                                .eq('id', bannerState.currentBannerId);
                            if (retryError) throw retryError;
                        } else {
                            throw error;
                        }
                    }

                    statusEl.textContent = 'Saved';
                    statusEl.style.color = 'var(--success)';

                    // Trigger banner reload on main site
                    triggerBannerReloadGlobally();

                    // Reload banners
                    loadBannerList();
                } else {
                    // New banner - upload the image first
                    const uploadInput = document.getElementById('bannerUploadInput');
                    if (uploadInput && uploadInput.files.length > 0) {
                        const file = uploadInput.files[0];

                        // Upload image to Supabase storage
                        statusEl.textContent = 'Uploading image...';
                        const imageUrl = await uploadBannerImage(file, api);

                        // Prepare banner data
                        const bannerData = {
                            image_url: imageUrl,
                            title: file.name.replace(/\.[^/.]+$/, ''),
                            image_fit: bannerState.fit,
                            custom_position_x: Math.round(bannerState.posX),
                            custom_position_y: Math.round(bannerState.posY),
                            custom_position_x_mobile: Math.round(bannerState.posX_mobile),
                            custom_position_y_mobile: Math.round(bannerState.posY_mobile),
                            link_type: 'none',
                            order_index: 0,
                            active: true
                        };

                        // Only include image_scale if needed
                        if (bannerState.fit === 'none') {
                            bannerData.image_scale = bannerState.scale;
                        }

                        // Create new banner
                        const { error } = await api.db
                            .from('banners')
                            .insert([bannerData]);

                        if (error) {
                            // If error mentions image_scale, retry without it
                            if (error.message && error.message.includes('image_scale')) {
                                console.warn('image_scale column not found, retrying without it...');
                                delete bannerData.image_scale;
                                const { error: retryError } = await api.db
                                    .from('banners')
                                    .insert([bannerData]);
                                if (retryError) throw retryError;
                            } else {
                                throw error;
                            }
                        }

                        statusEl.textContent = 'Saved';
                        statusEl.style.color = 'var(--success)';

                        // Clear upload input
                        uploadInput.value = '';

                        // Trigger banner reload on main site
                        triggerBannerReloadGlobally();

                        // Reload banners
                        loadBannerList();
                    } else {
                        alert('Please upload an image file');
                        statusEl.textContent = 'Error';
                        statusEl.style.color = 'var(--error)';
                    }
                }
            } catch (error) {
                console.error('Error saving banner:', error);
                console.log('Error message:', error.message);
                console.log('Error details:', error.details);
                console.log('Error hint:', error.hint);
                console.log('Error code:', error.code);
                console.log('Full error object:', JSON.stringify(error, null, 2));

                let errorMsg = error.message || 'Unknown error';
                if (error.details) errorMsg += '\n\nDetails: ' + error.details;
                if (error.hint) errorMsg += '\n\nHint: ' + error.hint;
                if (error.code) errorMsg += '\n\nCode: ' + error.code;

                alert('Failed to save banner:\n' + errorMsg);
                statusEl.textContent = 'Error';
                statusEl.style.color = 'var(--error)';
            }
        }

        // Clear Banner
        function clearBanner() {
            if (!confirm('Clear current banner?')) return;

            bannerState.currentImage = null;
            bannerState.posX = 50;
            bannerState.posY = 50;
            bannerState.posX_mobile = 50;
            bannerState.posY_mobile = 50;
            bannerState.fit = 'cover';
            bannerState.scale = 100;
            bannerState.currentBannerId = null;

            // Reset UI
            setImageFit('cover');

            const preview = document.getElementById('bannerLivePreview');
            preview.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--muted); text-align: center;">
                    <div>
                        <i class="fa-solid fa-image" style="font-size: 32px; margin-bottom: 8px; opacity: 0.3;"></i>
                        <p style="font-size: 13px;">Select or upload a banner to preview</p>
                    </div>
                </div>
            `;

            document.getElementById('uploadInfo').textContent = 'Recommended: 1920Ã—100px';
            document.getElementById('bannerStatus').textContent = 'Ready';
            document.getElementById('bannerStatus').style.color = 'var(--success)';

            updatePositionDisplays();
        }

        // Load Banner List
        async function loadBannerList(retryCount = 0) {
            const container = document.getElementById('bannerListContainer');
            if (!container) return;

            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--muted);">
                    <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 32px; margin-bottom: 16px;"></i>
                    <p>Loading banners...</p>
                </div>
            `;

            // Wait for API to be available (max 3 retries)
            if (!window.api && !window.adminBanners && !window.adminPanel && retryCount < 3) {
                console.log('Waiting for API... retry', retryCount + 1);
                setTimeout(() => loadBannerList(retryCount + 1), 1000);
                return;
            }

            try {
                // Use adminPanel.api directly
                const api = window.adminPanel?.api;

                // Check if we have API access
                if (!api || !api.db) {
                    throw new Error('AdminPanel API not available. Try refreshing the page.');
                }

                // Always load directly from database
                console.log('Loading banners from database using adminPanel.api...');
                const { data, error } = await api.db
                    .from('banners')
                    .select('*')
                    .order('order_index', { ascending: true })
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Database error:', error);
                    throw error;
                }

                const banners = data || [];
                console.log('Query returned:', banners.length, 'banners');

                if (banners.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--muted);">
                            <i class="fa-solid fa-image" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                            <p>No banners yet. Upload your first banner above!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = banners.map(banner => `
                    <div class="banner-list-item" onclick="selectBanner('${banner.id}', '${banner.image_url}', ${banner.custom_position_x || 50}, ${banner.custom_position_y || 50}, '${banner.image_fit || 'cover'}', ${banner.image_scale || 100}, ${banner.custom_position_x_mobile || 50}, ${banner.custom_position_y_mobile || 50})">
                        <div class="banner-list-thumb">
                            <img src="${banner.image_url}" alt="${banner.title || 'Banner'}" style="object-fit: cover;">
                        </div>
                        <div class="banner-list-info">
                            <div class="banner-list-title">${banner.title || 'Untitled Banner'}</div>
                            <div class="banner-list-meta">
                                <span style="color: ${banner.active ? 'var(--success)' : 'var(--muted)'}">${banner.active ? 'â— Active' : 'â—‹ Inactive'}</span>
                                ${banner.custom_position_x ? ` â€¢ ${Math.round(banner.custom_position_x)}%Ã—${Math.round(banner.custom_position_y)}%` : ''}
                            </div>
                        </div>
                        <button class="btn secondary btn-sm" onclick="event.stopPropagation(); deleteBannerById('${banner.id}')">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `).join('');

                console.log('âœ“ Loaded', banners.length, 'banners');
            } catch (error) {
                console.error('Error loading banners:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--error);">
                        <i class="fa-solid fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 16px;"></i>
                        <p>Failed to load banners</p>
                        <p style="font-size: 12px; margin-top: 8px; opacity: 0.8;">${error.message}</p>
                        <button class="btn secondary" style="margin-top: 12px;" onclick="loadBannerList()">
                            <i class="fa-solid fa-rotate"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        // Select Banner from List
        function selectBanner(id, imageUrl, posX = 50, posY = 50, fit = 'cover', scale = 100, posX_mobile = 50, posY_mobile = 50) {
            bannerState.currentImage = imageUrl;
            bannerState.currentBannerId = id;
            bannerState.posX = posX;
            bannerState.posY = posY;
            bannerState.posX_mobile = posX_mobile;
            bannerState.posY_mobile = posY_mobile;
            bannerState.fit = fit;
            bannerState.scale = scale;

            // Remember this banner for auto-load
            localStorage.setItem('lastSelectedBannerId', id);

            // Update fit buttons
            setImageFit(fit);

            // Update scale slider
            const scaleInput = document.getElementById('imageScale');
            if (scaleInput) scaleInput.value = scale;
            document.getElementById('scaleValue').textContent = scale;

            updateBannerPreview();
            updatePositionDisplays();

            // Update status
            document.getElementById('bannerStatus').textContent = 'Loaded';
            document.getElementById('bannerStatus').style.color = 'var(--info)';

            // Highlight selected
            document.querySelectorAll('.banner-list-item').forEach(item => {
                item.classList.remove('selected');
            });
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('selected');
            }
        }

        // Upload Banner Image
        async function uploadBannerImage(file, api) {
            try {
                // Generate unique filename
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                const filePath = `banners/${fileName}`;

                // Upload to Supabase Storage
                const { data, error } = await api.db.storage
                    .from('banners')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) throw error;

                // Get public URL
                const { data: urlData } = api.db.storage
                    .from('banners')
                    .getPublicUrl(filePath);

                return urlData.publicUrl;
            } catch (error) {
                console.error('Error uploading image:', error);
                throw new Error('Failed to upload image: ' + error.message);
            }
        }

        // Delete Banner
        async function deleteBannerById(id) {
            if (!confirm('Delete this banner?')) return;

            try {
                const api = window.adminPanel?.api;
                if (!api) {
                    alert('API not available');
                    return;
                }

                const { error } = await api.db
                    .from('banners')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                // Trigger banner reload on main site
                triggerBannerReloadGlobally();

                loadBannerList();

                // Clear editor if this was the selected banner
                if (bannerState.currentBannerId === id) {
                    clearBanner();
                    localStorage.removeItem('lastSelectedBannerId');
                }
            } catch (error) {
                console.error('Error deleting banner:', error);
                alert('Failed to delete banner: ' + error.message);
            }
        }

        // Trigger banner reload on main site globally
        function triggerBannerReloadGlobally() {
            // Use localStorage event to communicate across tabs
            const timestamp = Date.now();
            localStorage.setItem('bannerUpdateTrigger', timestamp.toString());

            console.log('Triggered global banner reload at', timestamp);

            // Also dispatch custom event for same-page updates
            window.dispatchEvent(new CustomEvent('bannersUpdated', {
                detail: { timestamp }
            }));
        }

        // Debug: Check System Status
        function checkSystemStatus() {
            const statusEl = document.getElementById('systemStatus');

            const status = {
                'window.adminPanel': !!window.adminPanel,
                'window.adminPanel.api': !!(window.adminPanel && window.adminPanel.api),
                'window.adminPanel.api.db': !!(window.adminPanel && window.adminPanel.api && window.adminPanel.api.db),
                'window.adminBanners': !!window.adminBanners,
                'window.adminBanners.api': !!(window.adminBanners && window.adminBanners.api),
                'window.adminBanners.banners': !!(window.adminBanners && window.adminBanners.banners),
                'banners count': window.adminBanners?.banners?.length || 0,
                'window.api': !!window.api,
            };

            let html = '<div style="display: grid; grid-template-columns: 200px 1fr; gap: 8px;">';
            for (const [key, value] of Object.entries(status)) {
                const color = value === true || (typeof value === 'number' && value > 0) ? 'var(--success)' : 'var(--error)';
                html += `
                    <div style="color: var(--muted);">${key}:</div>
                    <div style="color: ${color}; font-weight: 600;">${value}</div>
                `;
            }
            html += '</div>';

            // Add try direct database call button
            html += `
                <button class="btn secondary" style="width: 100%; margin-top: 12px; font-size: 12px;" onclick="testDirectDatabaseCall()">
                    <i class="fa-solid fa-database"></i> Test Direct DB Call
                </button>
            `;

            statusEl.innerHTML = html;

            // Also log to console
            console.log('System Status:', status);
            console.log('window.adminBanners:', window.adminBanners);
            console.log('window.api:', window.api);
        }

        // Test direct database call
        async function testDirectDatabaseCall() {
            const statusEl = document.getElementById('systemStatus');
            statusEl.innerHTML = '<div style="color: var(--warning);">Testing database connection...</div>';

            try {
                const api = window.adminPanel?.api || window.adminBanners?.api || window.api;

                if (!api) {
                    throw new Error('No API object found');
                }

                if (!api.db) {
                    throw new Error('API object has no db property');
                }

                console.log('Attempting to query banners table...');
                const { data, error } = await api.db
                    .from('banners')
                    .select('*')
                    .limit(5);

                if (error) {
                    throw error;
                }

                statusEl.innerHTML = `
                    <div style="color: var(--success); margin-bottom: 8px;">
                        âœ“ Database connection successful!
                    </div>
                    <div style="color: var(--muted);">
                        Found ${data.length} banner(s)
                    </div>
                    <pre style="margin-top: 12px; padding: 12px; background: var(--bg); border-radius: 6px; overflow-x: auto; font-size: 10px;">${JSON.stringify(data, null, 2)}</pre>
                    <button class="btn" style="width: 100%; margin-top: 12px; font-size: 12px;" onclick="loadBannerList()">
                        <i class="fa-solid fa-rotate"></i> Load These Banners
                    </button>
                `;

                console.log('Database test result:', data);
            } catch (error) {
                statusEl.innerHTML = `
                    <div style="color: var(--error); margin-bottom: 8px;">
                        âœ— Database test failed
                    </div>
                    <div style="color: var(--muted); font-size: 11px;">
                        ${error.message}
                    </div>
                    <pre style="margin-top: 12px; padding: 12px; background: var(--bg); border-radius: 6px; overflow-x: auto; font-size: 10px; color: var(--error);">${error.stack || error.toString()}</pre>
                `;
                console.error('Database test error:', error);
            }
        }

        // Voting Hero Background Functions
        let votingHeroImageFile = null;

        // Handle file selection
        document.addEventListener('DOMContentLoaded', () => {
            const uploadInput = document.getElementById('votingHeroUpload');
            if (uploadInput) {
                uploadInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        votingHeroImageFile = file;
                        // Preview the image
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const preview = document.getElementById('votingHeroPreview');
                            preview.style.backgroundImage = `url('${event.target.result}')`;
                            preview.innerHTML = '';

                            const status = document.getElementById('votingHeroStatus');
                            status.innerHTML = `<div style="color: var(--info);">âœ“ Image selected: ${file.name}</div>`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Load existing image on panel load
            loadVotingHeroImage();
        });

        async function saveVotingHeroImage() {
            const status = document.getElementById('votingHeroStatus');

            if (!votingHeroImageFile) {
                status.innerHTML = `<div style="color: var(--warning);">âš  Please select an image first</div>`;
                return;
            }

            try {
                status.innerHTML = `<div style="color: var(--info);">Uploading...</div>`;

                // Upload to Supabase storage
                const fileName = `voting-hero-${Date.now()}.${votingHeroImageFile.name.split('.').pop()}`;
                const { data, error } = await window.adminPanel.api.db.storage
                    .from('banners')
                    .upload(`voting/${fileName}`, votingHeroImageFile, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) throw error;

                // Get public URL
                const { data: { publicUrl } } = window.adminPanel.api.db.storage
                    .from('banners')
                    .getPublicUrl(`voting/${fileName}`);

                // Save URL to localStorage
                localStorage.setItem('votingHeroBackgroundUrl', publicUrl);

                status.innerHTML = `<div style="color: var(--success);">âœ“ Image uploaded successfully!</div>`;
                votingHeroImageFile = null;

            } catch (error) {
                console.error('Upload error:', error);
                status.innerHTML = `<div style="color: var(--error);">âœ— Upload failed: ${error.message}</div>`;
            }
        }

        function loadVotingHeroImage() {
            const url = localStorage.getItem('votingHeroBackgroundUrl');
            if (url) {
                const preview = document.getElementById('votingHeroPreview');
                if (preview) {
                    preview.style.backgroundImage = `url('${url}')`;
                    preview.innerHTML = '';
                }
            }
        }

        function removeVotingHeroImage() {
            localStorage.removeItem('votingHeroBackgroundUrl');
            const preview = document.getElementById('votingHeroPreview');
            if (preview) {
                preview.style.backgroundImage = '';
                preview.innerHTML = `
                    <div style="text-align: center;">
                        <i class="fa-solid fa-image" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                        <p>No background image set</p>
                    </div>
                `;
            }
            const status = document.getElementById('votingHeroStatus');
            status.innerHTML = `<div style="color: var(--success);">âœ“ Background image removed</div>`;
        }

        // Market Creation Functions
        function switchMarketTab(tabOrEvent) {
            // Determine if called with event or tab string
            const tab = typeof tabOrEvent === 'string' ? tabOrEvent : tabOrEvent?.target?.dataset?.tab;

            // Update tab buttons
            document.querySelectorAll('.market-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Activate the correct tab button
            const targetBtn = document.querySelector(`.market-tab[data-tab="${tab}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.market-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tab === 'create') {
                document.getElementById('createMarketTab').classList.add('active');
            } else if (tab === 'all') {
                document.getElementById('allMarketsTab').classList.add('active');
                // Load markets if not already loaded
                if (window.adminPanel) {
                    window.adminPanel.switchView('markets');
                }
            }
        }

        function updatePreview() {
            // Update title
            const title = document.getElementById('marketTitle').value || 'Market Title';
            document.getElementById('previewTitle').textContent = title;

            // Update description - get from Quill editor with rich formatting
            const previewDesc = document.getElementById('previewDescription');
            if (quillEditor) {
                const textContent = quillEditor.getText().trim();
                if (textContent) {
                    const htmlContent = quillEditor.root.innerHTML;
                    previewDesc.innerHTML = htmlContent;
                } else {
                    previewDesc.textContent = 'Market description will appear here...';
                }
            } else {
                previewDesc.textContent = 'Market description will appear here...';
            }

            // Update category
            const category = document.getElementById('marketCategory').value || 'SPORTS';
            document.getElementById('previewCategory').textContent = category.toUpperCase();

            // Update options
            const optionInputs = document.querySelectorAll('.market-option-input');
            const previewOptions = document.getElementById('previewOptions');

            if (optionInputs.length > 0) {
                const options = Array.from(optionInputs)
                    .map(input => input.value.trim())
                    .filter(value => value !== '');

                if (options.length > 0) {
                    const evenOdds = (100 / options.length).toFixed(0);
                    previewOptions.innerHTML = options.map(option => `
                        <div class="preview-option">
                            <div class="preview-option-label">${option}</div>
                            <div class="preview-option-odds">${evenOdds}%</div>
                        </div>
                    `).join('');
                } else {
                    previewOptions.innerHTML = `
                        <div class="preview-option">
                            <div class="preview-option-label">YES</div>
                            <div class="preview-option-odds">50%</div>
                        </div>
                        <div class="preview-option">
                            <div class="preview-option-label">NO</div>
                            <div class="preview-option-odds">50%</div>
                        </div>
                    `;
                }
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewImage = document.getElementById('previewImage');
                    previewImage.innerHTML = `<img src="${e.target.result}" alt="Market Image">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function addMarketOption() {
            const container = document.getElementById('marketOptionsContainer');
            const optionCount = container.querySelectorAll('.market-option-group').length;

            const optionGroup = document.createElement('div');
            optionGroup.className = 'market-option-group';
            optionGroup.innerHTML = `
                <input
                    type="text"
                    class="market-form-input market-option-input"
                    placeholder="Option ${optionCount + 1}"
                    oninput="updatePreview()"
                >
                <button
                    type="button"
                    class="market-option-remove"
                    onclick="removeMarketOption(this)"
                >
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;

            container.appendChild(optionGroup);
            updatePreview();
        }

        function removeMarketOption(button) {
            const container = document.getElementById('marketOptionsContainer');
            const optionGroups = container.querySelectorAll('.market-option-group');

            // Don't allow removing if only 2 options remain
            if (optionGroups.length <= 2) {
                alert('Minimum 2 options required');
                return;
            }

            button.closest('.market-option-group').remove();
            updatePreview();
        }

        function resetMarketForm() {
            if (confirm('Are you sure you want to reset the form?')) {
                document.getElementById('createMarketForm').reset();

                // Reset Quill editor
                if (quillEditor) {
                    quillEditor.setText('');
                }

                // Reset preview image
                document.getElementById('previewImage').innerHTML = '<i class="fa-solid fa-image"></i>';

                // Reset options to default 2
                const container = document.getElementById('marketOptionsContainer');
                container.innerHTML = `
                    <div class="market-option-group">
                        <input
                            type="text"
                            class="market-form-input market-option-input"
                            placeholder="Option 1 (e.g., YES)"
                            required
                            oninput="updatePreview()"
                        >
                    </div>
                    <div class="market-option-group">
                        <input
                            type="text"
                            class="market-form-input market-option-input"
                            placeholder="Option 2 (e.g., NO)"
                            required
                            oninput="updatePreview()"
                        >
                    </div>
                `;

                updatePreview();
            }
        }

        // Initialize Quill rich text editor
        let quillEditor = null;

        // Handle create market form submission
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Quill editor for market description
            const editorContainer = document.getElementById('marketDescriptionEditor');
            if (editorContainer && typeof Quill !== 'undefined') {
                quillEditor = new Quill(editorContainer, {
                    theme: 'snow',
                    placeholder: 'Provide detailed information about the market...',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline', 'strike'],
                            ['blockquote', 'code-block'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'header': [1, 2, 3, false] }],
                            ['link'],
                            ['clean']
                        ]
                    }
                });

                // Update preview when editor content changes
                quillEditor.on('text-change', function() {
                    updatePreview();
                });
            }

            const createMarketForm = document.getElementById('createMarketForm');
            if (createMarketForm) {
                createMarketForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // Gather form data
                    const title = document.getElementById('marketTitle').value;

                    // Get description from Quill editor
                    let description = '';
                    if (quillEditor) {
                        description = quillEditor.getText().trim();
                        // Check if editor is empty
                        if (!description) {
                            alert('Please provide a market description');
                            return;
                        }
                    } else {
                        alert('Editor not initialized');
                        return;
                    }

                    const category = document.getElementById('marketCategory').value;
                    const resolutionDate = document.getElementById('marketResolutionDate').value;
                    const liquidity = document.getElementById('marketLiquidity').value || 0;
                    const fee = document.getElementById('marketFee').value || 2;

                    // Get options
                    const optionInputs = document.querySelectorAll('.market-option-input');
                    const options = Array.from(optionInputs)
                        .map(input => input.value.trim())
                        .filter(value => value !== '');

                    if (options.length < 2) {
                        alert('Please provide at least 2 options');
                        return;
                    }

                    // Get image
                    const imageFile = document.getElementById('marketImage').files[0];
                    let imageUrl = null;

                    try {
                        // Upload image if provided
                        if (imageFile && window.adminPanel) {
                            const fileName = `market-${Date.now()}.${imageFile.name.split('.').pop()}`;
                            const { data: uploadData, error: uploadError } = await window.adminPanel.api.db.storage
                                .from('banners')
                                .upload(`markets/${fileName}`, imageFile, {
                                    cacheControl: '3600',
                                    upsert: false
                                });

                            if (uploadError) throw uploadError;

                            const { data: { publicUrl } } = window.adminPanel.api.db.storage
                                .from('banners')
                                .getPublicUrl(`markets/${fileName}`);

                            imageUrl = publicUrl;
                        }

                        // Create market
                        const marketData = {
                            title,
                            description,
                            category,
                            image_url: imageUrl,
                            end_date: resolutionDate,
                            yes_price: 0.5,
                            no_price: 0.5,
                            total_volume: 0,
                            bettor_count: 0,
                            status: 'active'
                        };

                        if (window.adminPanel) {
                            const newMarket = await window.adminPanel.api.createMarket(marketData);

                            if (newMarket && newMarket.id) {
                                // Redirect to main site market detail page
                                window.location.href = `index.html?openMarket=${newMarket.id}`;
                            } else {
                                alert('Market created successfully!');
                                // Switch to All Markets tab
                                switchMarketTab('all');
                                // Reset form
                                resetMarketForm();
                            }
                        } else {
                            console.log('Market data:', marketData);
                            alert('Admin panel not initialized. Market data logged to console.');
                        }

                    } catch (error) {
                        console.error('Error creating market:', error);
                        alert('Failed to create market: ' + error.message);
                    }
                });
            }
        });

        // Function to clean HTML from market descriptions
        async function cleanMarketDescriptions() {
            if (!window.adminPanel || !window.adminPanel.api) {
                alert('Admin panel not initialized');
                return;
            }

            try {
                // Get all markets
                const { data: markets, error } = await window.adminPanel.api.db
                    .from('markets')
                    .select('*');

                if (error) throw error;

                let cleanedCount = 0;

                for (const market of markets) {
                    // Check if description contains HTML tags
                    if (market.description && /<[^>]+>/.test(market.description)) {
                        // Strip HTML tags and decode entities
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = market.description;
                        const cleanText = tempDiv.textContent || tempDiv.innerText || '';

                        // Update market with clean description
                        const { error: updateError } = await window.adminPanel.api.db
                            .from('markets')
                            .update({ description: cleanText.trim() })
                            .eq('id', market.id);

                        if (!updateError) {
                            cleanedCount++;
                            console.log(`Cleaned market: ${market.title}`);
                        } else {
                            console.error(`Failed to clean market ${market.title}:`, updateError);
                        }
                    }
                }

                alert(`Successfully cleaned ${cleanedCount} market description(s)!`);

                // Reload markets view if active
                if (window.adminPanel) {
                    window.adminPanel.switchView('markets');
                }
            } catch (error) {
                console.error('Error cleaning market descriptions:', error);
                alert('Failed to clean market descriptions: ' + error.message);
            }
        }

        // Auto-run cleanup on page load (runs once)
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for admin panel to initialize
            setTimeout(() => {
                if (window.adminPanel && window.adminPanel.api) {
                    console.log('Running market description cleanup...');
                    cleanMarketDescriptions();
                }
            }, 3000);
        });
    </script>
</body>
</html>
